<!doctype html>
<!--[if IE 8]>
<html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" class="no-js">
<!--<![endif]-->








    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script type="text/javascript" src="/assets/js/viewport-min-width.js?v1547266080100021829"></script>
        <meta name="description"
              content="Official Phalcon Documentation">
        <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework, php extension, next generation framework, docs, documentation">
        <meta name="author" href="/humans.txt">
        <meta name="generator" content="Phalcon Team - Jekyll - Netlify">

        <link href="https://phalcon-docs4.netlify.com/3.2/en/db-odm.html" rel="canonical">
        <title>Phalcon Framework Documentation</title>

        <!-- Twitter -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@zephirlang">
        <meta name="twitter:creator" content="@zephirlang">
        <meta name="twitter:title" content="Phalcon Framework Documentation">
        <meta name="twitter:description" content="Official Phalcon Documentation">
        <meta name="twitter:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <!-- Facebook -->
        <meta property="og:url" content="https://phalcon-docs4.netlify.com">
        <meta property="og:title" content="Phalcon Framework Documentation">
        <meta property="og:description" content="Official Phalcon Documentation">
        <meta property="og:type" content="website">
        <meta property="og:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <meta name="msapplication-TileColor" content="#FFFFFF">
        <meta name="msapplication-square70x70logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-70x70.png">
        <meta name="msapplication-TileImage"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-144x144.png">
        <meta name="msapplication-square150x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-150x150.png">
        <meta name="msapplication-wide310x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x150.png">
        <meta name="msapplication-square310x310logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x310.png">

        <link rel="apple-touch-icon"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon.png">

        <link rel="apple-touch-icon-precomposed"
              sizes="57x57"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="60x60"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="72x72"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="76x76"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="114x114"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="120x120"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="144x144"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="152x152"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-152x152.png">

        <link rel="icon"
              type="image/png"
              sizes="16x16"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-16x16.png">
        <link rel="icon"
              type="image/png"
              sizes="32x32"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-32x32.png">
        <link rel="icon"
              type="image/png"
              sizes="96x96"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-96x96.png">
        <link rel="icon"
              type="image/png"
              sizes="128x128"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-128x128.png">
        <link rel="icon"
              type="image/png"
              sizes="196x196"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-196x196.png">
        <link rel="shortcut icon"
              type="image/png"
              href="https://assets.phalconphp.com/phalcon/favicon.ico"/>

        <link rel="alternate"
              type="application/rss+xml"
              title=" - "
              href="https://phalcon-docs4.netlify.com/feed.xml">

        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"
              integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE="
              crossorigin="anonymous" />
        <link rel="stylesheet" href="/assets/css/monokai.css?v1547266080100021829" />
        <link rel="stylesheet" href="/assets/css/style.css?v1547266080100021829" />

        <script defer src="https://use.fontawesome.com/releases/v5.6.1/js/all.js"
                integrity="sha384-R5JkiUweZpJjELPWqttAYmYM1P3SNEJRM6ecTQF05pFFtxmCO+Y1CiUhvuDzgSVZ"
                crossorigin="anonymous"></script>
        
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90300500-6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90300500-6');
    </script>

    </head>


<body onclick="o2.allNavSlideUp()">
    <header class="header-image-doc">
        <div class="container">
            <div class="header-wrapper">
                <div class="clearfix">
                    <div class="row">
                        <div class="col-md-2 col-sm-3  col-xs-8">
                            <div class="header-image__logo-wrapper">
                                <a href="/3.2/en">
                                    <img class="logo-img" src="/assets/images/header_logo.svg" alt="logo">
                                </a>
                            </div>
                        </div>
                        <div class="col-md-10 col-sm-9 top-menu">

                            <div class="nav-icon" onclick="o2.showMobileMenu();">
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                            </div>
                            <nav class="header-nav">
                                <ul>
                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                 alt="">
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list" onclick="event.stopPropagation();">
                                            
                                                <a href="/3.2/en/db-odm" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                         alt="English (US)">
                                                    English (US)
                                                </a>
                                            
                                        </div>
                                    </li>

                                        <li class="nav-item" onclick="o2.toggleState(this, event);">
                                            <div class="nav-item__selected custom-select__version">
                                                 3.2
                                                <span class="caret"></span>
                                            </div>
                                            <div class="nav-item__list" onclick="event.stopPropagation();">
                                                
                                                <a href="/3.4/en/db-odm" class="custom-select__list-item">
                                                    <span>3.4</span>
                                                </a>
                                                
                                                <a href="/3.3/en/db-odm" class="custom-select__list-item">
                                                    <span>3.3</span>
                                                </a>
                                                
                                                <a href="/3.2/en/db-odm" class="custom-select__list-item">
                                                    <span>3.2</span>
                                                </a>
                                                
                                                <a href="/3.1/en/db-odm" class="custom-select__list-item">
                                                    <span>3.1</span>
                                                </a>
                                                
                                                <a href="/4.0/en/db-odm" class="custom-select__list-item">
                                                    <span>4.0</span>
                                                </a>
                                                
                                            </div>
                                        </li>

                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list">
                                            <a href="https://phalcon.link/forum" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                            <a href="https://phalcon.link/blog" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                            <a href="https://phalcon.link/resources" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                            <div class="nav-item__divider"></div>
                                            <a href="https://phalcon.link/f" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                            <a href="https://phalcon.link/t" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                            <a href="https://phalcon.link/gab" class="custom-select__list-item" target="_blank">
                                                
                                            </a>
                                        </div>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/about">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/sponsors">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/fund">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/download">
                                            
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                        <div class="header-nav-mobile">
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    <img class="lang-image"
                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                         alt="">
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.2/en/db-odm">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                 alt="English (US)">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this,event)">
                                     3.2
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.4/en/db-odm">
                                            <span>3.4</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.3/en/db-odm">
                                            <span>3.3</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.2/en/db-odm">
                                            <span>3.2</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.1/en/db-odm">
                                            <span>3.1</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/4.0/en/db-odm">
                                            <span>4.0</span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    
                                    <span class="caret"></span>
                                </div>
                                <ul style="display:none;">
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/forum" target="_blank">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/blog" target="_blank">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/resources" target="_blank">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/f" target="_blank">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/t" target="_blank">
                                            
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/gab" target="_blank">
                                            
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/about">
                                    
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/sponsors">
                                    
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/fund">
                                    
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/download">
                                    
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <div class="container-fluid article-page-wrap">
        <div class="row">
            <div>
                <div class="col-md-2 sidebar hidden-xs">
                    <div class="sidebar--spacer">&nbsp;</div>
                </div>
                <div class="m-t-md m-b-lg" id="articles">
                    <div class="article-content">
                        







                        <section class="documentation-section">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-8 col-lg-9 parse-content">
                                        <div>
                                            <a class="article-content-edit-link pull-right"
                                               href="https://crowdin.com/project/phalcon-documentation/en">
                                                
                                            </a>
                                            <br>
                                        </div>
                                        <h5 class="alert alert-info">Please note that if you are using the Mongo driver provided by PHP 7, the ODM will not work for you. There is an incubator adapter but all the Mongo code must be rewritten (new Bson type instead of arrays, no MongoId, no MongoDate, etc…). Please ensure that you test your code before upgrading to PHP 7 and/or Phalcon 3+</h5>

<p><a name="overview"></a></p>
<h1 id="odm-object-document-mapper">ODM (Object-Document Mapper)</h1>
<p>In addition to its ability to <a href="/3.2/en/models">map tables</a> in relational databases, Phalcon can map documents from NoSQL databases. The ODM offers a CRUD functionality, events, validations among other services.</p>

<p>Due to the absence of SQL queries and planners, NoSQL databases can see real improvements in performance using the Phalcon approach. Additionally, there are no SQL building reducing the possibility of SQL injections.</p>

<p>The following NoSQL databases are supported:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="http://www.mongodb.org/">MongoDB</a></td>
      <td>MongoDB is a scalable, high-performance, open source NoSQL database.</td>
    </tr>
  </tbody>
</table>

<p><a name="creating-models"></a></p>
<h2 id="creating-models">Creating Models</h2>
<p>A model is a class that extends from <a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a>. It must be placed in the models directory. A model file must contain a single class; its class name should be in camel case notation:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{

}
</code></pre>

<p>By default model <code>Robots</code> will refer to the collection <code>robots</code>. If you want to manually specify another name for the mapping collection, you can use the <code>setSource()</code> method:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function initialize()
    {
        $this-&gt;setSource('the_robots');
    }
}
</code></pre>

<p><a name="documents-to-objects"></a></p>
<h2 id="understanding-documents-to-objects">Understanding Documents To Objects</h2>
<p>Every instance of a model represents a document in the collection. You can easily access collection data by reading object properties. For example, for a collection <code>robots</code> with the documents:</p>

<pre><code class="language-bash">$ mongo test
MongoDB shell version: 1.8.2
connecting to: test
&gt; db.robots.find()
{ '_id' : ObjectId('508735512d42b8c3d15ec4e1'), 'name' : 'Astro Boy', 'year' : 1952,
    'type' : 'mechanical' }
{ '_id' : ObjectId('5087358f2d42b8c3d15ec4e2'), 'name' : 'Bender', 'year' : 1999,
    'type' : 'mechanical' }
{ '_id' : ObjectId('508735d32d42b8c3d15ec4e3'), 'name' : 'Wall-E', 'year' : 2008 }
&gt;
</code></pre>

<p><a name="namespaces"></a></p>
<h2 id="models-in-namespaces">Models in Namespaces</h2>
<p>Namespaces can be used to avoid class name collision. In this case it is necessary to indicate the name of the related collection using the <code>setSource()</code> method:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function initialize()
    {
        $this-&gt;setSource('robots');
    }
}
</code></pre>

<p>You could find a certain document by its ID and then print its name:</p>

<pre><code class="language-php">&lt;?php

// Find record with _id = '5087358f2d42b8c3d15ec4e2'
$robot = Robots::findById('5087358f2d42b8c3d15ec4e2');

// Prints 'Bender'
echo $robot-&gt;name;
</code></pre>

<p>Once the record is in memory, you can make modifications to its data and then save changes:</p>

<pre><code class="language-php">&lt;?php

$robot = Robots::findFirst(
    [
        [
            'name' =&gt; 'Astro Boy',
        ]
    ]
);

$robot-&gt;name = 'Voltron';

$robot-&gt;save();
</code></pre>

<p><a name="connection-setup"></a></p>
<h2 id="setting-a-connection">Setting a Connection</h2>
<p>Connections are retrieved from the services container. By default, Phalcon tries to find the connection in a service called <code>mongo</code>:</p>

<pre><code class="language-php">&lt;?php

// Simple database connection to localhost
$di-&gt;set(
    'mongo',
    function () {
        $mongo = new MongoClient();

        return $mongo-&gt;selectDB('store');
    },
    true
);

// Connecting to a domain socket, falling back to localhost connection
$di-&gt;set(
    'mongo',
    function () {
        $mongo = new MongoClient(
            'mongodb:///tmp/mongodb-27017.sock,localhost:27017'
        );

        return $mongo-&gt;selectDB('store');
    },
    true
);
</code></pre>

<p><a name="finding-documents"></a></p>
<h2 id="finding-documents">Finding Documents</h2>
<p>As <a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a> relies on the Mongo PHP extension you have the same facilities to query documents and convert them transparently to model instances:</p>

<pre><code class="language-php">&lt;?php

// How many robots are there?
$robots = Robots::find();
echo 'There are ', count($robots), "\n";

// How many mechanical robots are there?
$robots = Robots::find(
    [
        [
            'type' =&gt; 'mechanical',
        ]
    ]
);
echo 'There are ', count($robots), "\n";

// Get and print mechanical robots ordered by name upward
$robots = Robots::find(
    [
        [
            'type' =&gt; 'mechanical',
        ],
        'sort' =&gt; [
            'name' =&gt; 1,
        ],
    ]
);

foreach ($robots as $robot) {
    echo $robot-&gt;name, "\n";
}

// Get first 100 mechanical robots ordered by name
$robots = Robots::find(
    [
        [
            'type' =&gt; 'mechanical',
        ],
        'sort'  =&gt; [
            'name' =&gt; 1,
        ],
        'limit' =&gt; 100,
    ]
);

foreach ($robots as $robot) {
    echo $robot-&gt;name, "\n";
}
</code></pre>

<p>You could also use the <code>findFirst()</code> method to get only the first record matching the given criteria:</p>

<pre><code class="language-php">&lt;?php

// What's the first robot in robots collection?
$robot = Robots::findFirst();
echo 'The robot name is ', $robot-&gt;name, "\n";

// What's the first mechanical robot in robots collection?
$robot = Robots::findFirst(
    [
        [
            'type' =&gt; 'mechanical',
        ]
    ]
);

echo 'The first mechanical robot name is ', $robot-&gt;name, "\n";
</code></pre>

<p>Both <code>find()</code> and <code>findFirst()</code> methods accept an associative array specifying the search criteria:</p>

<pre><code class="language-php">&lt;?php

// First robot where type = 'mechanical' and year = '1999'
$robot = Robots::findFirst(
    [
        'conditions' =&gt; [
            'type' =&gt; 'mechanical',
            'year' =&gt; '1999',
        ],
    ]
);

// All virtual robots ordered by name downward
$robots = Robots::find(
    [
        'conditions' =&gt; [
            'type' =&gt; 'virtual',
        ],
        'sort' =&gt; [
            'name' =&gt; -1,
        ],
    ]
);

// Find all robots that have more than 4 friends using the where condition
$robots = Robots::find(
    [
        'conditions' =&gt; [
            '$where' =&gt; 'this.friends.length &gt; 4',
        ]
    ]
);
</code></pre>

<p>The available query options are:</p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Description</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>conditions</code></td>
      <td>Search conditions for the find operation. Is used to extract only those records that fulfill a specified criterion. By default Phalcon_model assumes the first parameter are the conditions.</td>
      <td><code>'conditions' =&gt; array('$gt' =&gt; 1990)</code></td>
    </tr>
    <tr>
      <td><code>fields</code></td>
      <td>Returns specific columns instead of the full fields in the collection. When using this option an incomplete object is returned</td>
      <td><code>'fields' =&gt; array('name' =&gt; true)</code></td>
    </tr>
    <tr>
      <td><code>sort</code></td>
      <td>It’s used to sort the resultset. Use one or more fields as each element in the array, 1 means ordering upwards, -1 downward</td>
      <td><code>'sort' =&gt; array('name' =&gt; -1, 'status' =&gt; 1)</code></td>
    </tr>
    <tr>
      <td><code>limit</code></td>
      <td>Limit the results of the query to results to certain range</td>
      <td><code>'limit' =&gt; 10</code></td>
    </tr>
    <tr>
      <td><code>skip</code></td>
      <td>Skips a number of results</td>
      <td><code>'skip' =&gt; 50</code></td>
    </tr>
  </tbody>
</table>

<p>If you have experience with SQL databases, you may want to check the <a href="http://www.php.net/manual/en/mongo.sqltomongo.php">SQL to Mongo Mapping Chart</a>.</p>

<p><a name="finding-documents-fields"></a></p>
<h2 id="querying-specific-fields">Querying specific fields</h2>
<p>To query specific fields specific fields from a MongoDB database using the Phalcon ODM, all you need to do is:</p>

<pre><code class="language-php">$myRobots = Robots:find(
    [
        'fields' =&gt; ['name' =&gt; 1]
    ]
];
</code></pre>

<p>The <code>find()</code> above only returns a <code>name</code>. It can also be combined with a <code>condition</code>:</p>

<pre><code class="language-php">$myRobots = Robots:find(
    [
        ['type' =&gt; 'maid'],
        'fields' =&gt; ['name' =&gt; 1]
    ]
];
</code></pre>
<p>The example above returns the <code>name</code> of the robot with the <code>type = 'maid'</code>.</p>

<p><a name="aggregations"></a></p>
<h2 id="aggregations">Aggregations</h2>
<p>A model can return calculations using <a href="http://docs.mongodb.org/manual/applications/aggregation/">aggregation framework</a> provided by Mongo. The aggregated values are calculate without having to use MapReduce. With this option is easy perform tasks such as totaling or averaging field values:</p>

<pre><code class="language-php">&lt;?php

$data = Article::aggregate(
    [
        [
            '\$project' =&gt; [
                'category' =&gt; 1,
            ],
        ],
        [
            '\$group' =&gt; [
                '_id' =&gt; [
                    'category' =&gt; '\$category'
                ],
                'id'  =&gt; [
                    '\$max' =&gt; '\$_id',
                ],
            ],
        ],
    ]
);
</code></pre>

<p><a name="creating-updating"></a></p>
<h2 id="creating-updatingrecords">Creating Updating/Records</h2>
<p>The <code>Phalcon\Mvc\Collection::save()</code> method allows you to create/update documents according to whether they already exist in the collection associated with a model. The <code>save()</code> method is called internally by the create and update methods of <a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a>.</p>

<p>Also the method executes associated validators and events that are defined in the model:</p>

<pre><code class="language-php">&lt;?php

$robot = new Robots();

$robot-&gt;type = 'mechanical';
$robot-&gt;name = 'Astro Boy';
$robot-&gt;year = 1952;

if ($robot-&gt;save() === false) {
    echo "Umh, We can't store robots right now: \n";

    $messages = $robot-&gt;getMessages();

    foreach ($messages as $message) {
        echo $message, "\n";
    }
} else {
    echo 'Great, a new robot was saved successfully!';
}
</code></pre>

<p>The <code>_id</code> property is automatically updated with the <a href="http://www.php.net/manual/en/class.mongoid.php">MongoId</a> object created by the driver:</p>

<pre><code class="language-php">&lt;?php

$robot-&gt;save();

echo 'The generated id is: ', $robot-&gt;getId();
</code></pre>

<p><a name="validation-messages"></a></p>
<h3 id="validation-messages">Validation Messages</h3>
<p><a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a> has a messaging subsystem that provides a flexible way to output or store the validation messages generated during the insert/update processes.</p>

<p>Each message consists of an instance of the class <a href="api/Phalcon_Mvc_Model_Message">Phalcon\Mvc\Model\Message</a>. The set of messages generated can be retrieved with the method getMessages(). Each message provides extended information like the field name that generated the message or the message type:</p>

<pre><code class="language-php">&lt;?php

if ($robot-&gt;save() === false) {
    $messages = $robot-&gt;getMessages();

    foreach ($messages as $message) {
        echo 'Message: ', $message-&gt;getMessage();
        echo 'Field: ', $message-&gt;getField();
        echo 'Type: ', $message-&gt;getType();
    }
}
</code></pre>

<p><a name="events"></a></p>
<h3 id="validation-events-and-events-manager">Validation Events and Events Manager</h3>
<p>Models allow you to implement events that will be thrown when performing an insert or update. They help define business rules for a certain model. The following are the events supported by <a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a> and their order of execution:</p>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Name</th>
      <th>Can stop operation?</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Inserting/Updating</td>
      <td><code>beforeValidation</code></td>
      <td>YES</td>
      <td>Is executed before the validation process and the final insert/update to the database</td>
    </tr>
    <tr>
      <td>Inserting</td>
      <td><code>beforeValidationOnCreate</code></td>
      <td>YES</td>
      <td>Is executed before the validation process only when an insertion operation is being made</td>
    </tr>
    <tr>
      <td>Updating</td>
      <td><code>beforeValidationOnUpdate</code></td>
      <td>YES</td>
      <td>Is executed before the fields are validated for not nulls or foreign keys when an updating operation is being made</td>
    </tr>
    <tr>
      <td>Inserting/Updating</td>
      <td><code>onValidationFails</code></td>
      <td>YES (already stopped)</td>
      <td>Is executed before the validation process only when an insertion operation is being made</td>
    </tr>
    <tr>
      <td>Inserting</td>
      <td><code>afterValidationOnCreate</code></td>
      <td>YES</td>
      <td>Is executed after the validation process when an insertion operation is being made</td>
    </tr>
    <tr>
      <td>Updating</td>
      <td><code>afterValidationOnUpdate</code></td>
      <td>YES</td>
      <td>Is executed after the validation process when an updating operation is being made</td>
    </tr>
    <tr>
      <td>Inserting/Updating</td>
      <td><code>afterValidation</code></td>
      <td>YES</td>
      <td>Is executed after the validation process</td>
    </tr>
    <tr>
      <td>Inserting/Updating</td>
      <td><code>beforeSave</code></td>
      <td>YES</td>
      <td>Runs before the required operation over the database system</td>
    </tr>
    <tr>
      <td>Updating</td>
      <td><code>beforeUpdate</code></td>
      <td>YES</td>
      <td>Runs before the required operation over the database system only when an updating operation is being made</td>
    </tr>
    <tr>
      <td>Inserting</td>
      <td><code>beforeCreate</code></td>
      <td>YES</td>
      <td>Runs before the required operation over the database system only when an inserting operation is being made</td>
    </tr>
    <tr>
      <td>Updating</td>
      <td><code>afterUpdate</code></td>
      <td>NO</td>
      <td>Runs after the required operation over the database system only when an updating operation is being made</td>
    </tr>
    <tr>
      <td>Inserting</td>
      <td><code>afterCreate</code></td>
      <td>NO</td>
      <td>Runs after the required operation over the database system only when an inserting operation is being made</td>
    </tr>
    <tr>
      <td>Inserting/Updating</td>
      <td><code>afterSave</code></td>
      <td>NO</td>
      <td>Runs after the required operation over the database system</td>
    </tr>
  </tbody>
</table>

<p>To make a model to react to an event, we must to implement a method with the same name of the event:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function beforeValidationOnCreate()
    {
        echo 'This is executed before creating a Robot!';
    }
}
</code></pre>

<p>Events can be useful to assign values before performing an operation, for example:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Products extends Collection
{
    public function beforeCreate()
    {
        // Set the creation date
        $this-&gt;created_at = date('Y-m-d H:i:s');
    }

    public function beforeUpdate()
    {
        // Set the modification date
        $this-&gt;modified_in = date('Y-m-d H:i:s');
    }
}
</code></pre>

<p>Additionally, this component is integrated with the <a href="/3.2/en/events">Phalcon Events Manager</a> (<a href="api/Phalcon_Events_Manager">Phalcon\Events\Manager</a>), this means we can create listeners that run when an event is triggered.</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Events\Event;
use Phalcon\Events\Manager as EventsManager;

$eventsManager = new EventsManager();

// Attach an anonymous function as a listener for 'model' events
$eventsManager-&gt;attach(
    'collection:beforeSave',
    function (Event $event, $robot) {
        if ($robot-&gt;name === 'Scooby Doo') {
            echo "Scooby Doo isn't a robot!";

            return false;
        }

        return true;
    }
);

$robot = new Robots();

$robot-&gt;setEventsManager($eventsManager);

$robot-&gt;name = 'Scooby Doo';
$robot-&gt;year = 1969;

$robot-&gt;save();
</code></pre>

<p>In the example given above the EventsManager only acted as a bridge between an object and a listener (the anonymous function). If we want all objects created in our application use the same EventsManager, then we need to assign this to the Models Manager:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Events\Event;
use Phalcon\Events\Manager as EventsManager;
use Phalcon\Mvc\Collection\Manager as CollectionManager;

// Registering the collectionManager service
$di-&gt;set(
    'collectionManager',
    function () {
        $eventsManager = new EventsManager();

        // Attach an anonymous function as a listener for 'model' events
        $eventsManager-&gt;attach(
            'collection:beforeSave',
            function (Event $event, $model) {
                if (get_class($model) === 'Robots') {
                    if ($model-&gt;name === 'Scooby Doo') {
                        echo "Scooby Doo isn't a robot!";

                        return false;
                    }
                }

                return true;
            }
        );

        // Setting a default EventsManager
        $modelsManager = new CollectionManager();

        $modelsManager-&gt;setEventsManager($eventsManager);

        return $modelsManager;
    },
    true
);
</code></pre>

<p><a name="business-rules"></a></p>
<h3 id="implementing-a-business-rule">Implementing a Business Rule</h3>
<p>When an insert, update or delete is executed, the model verifies if there are any methods with the names of the events listed in the table above.</p>

<p>We recommend that validation methods are declared protected to prevent that business logic implementation from being exposed publicly.</p>

<p>The following example implements an event that validates the year cannot be smaller than 0 on update or insert:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    protected function beforeSave()
    {
        if ($this-&gt;year &lt; 0) {
            echo 'Year cannot be smaller than zero!';

            return false;
        }
    }
}
</code></pre>

<p>Some events return <code>false</code> as an indication to stop the current operation. If an event doesn’t return anything, <code>Phalcon\Mvc\Collection</code> will assume a <code>true</code> value.</p>

<p><a name="data-integrity"></a></p>
<h3 id="validating-data-integrity">Validating Data Integrity</h3>
<p><a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a> provides several events to validate data and implement business rules. The special <code>validation</code> event allows us to call built-in validators over the record. Phalcon exposes a few built-in validators that can be used at this stage of validation.</p>

<p>The following example shows how to use it:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;
use Phalcon\Validation;
use Phalcon\Validation\Validator\InclusionIn;
use Phalcon\Validation\Validator\Numericality;

class Robots extends Collection
{
    public function validation()
    {
        $validation = new Validation();

        $validation-&gt;add(
            'type',
            new InclusionIn(
                [
                    'message' =&gt; 'Type must be: mechanical or virtual',
                    'domain' =&gt; [
                        'Mechanical',
                        'Virtual',
                    ],
                ]
            )
        );

        $validation-&gt;add(
            'price',
            new Numericality(
                [
                    'message' =&gt; 'Price must be numeric'
                ]
            )
        );

        return $this-&gt;validate($validation);
    }
}
</code></pre>

<p>The example above performs a validation using the built-in validator <code>InclusionIn</code>. It checks that the value of the field <code>type</code> is in a <code>domain</code> list. If the value is not included in the list, then the validator will fail and return <code>false</code>.</p>

<h5 class="alert alert-warning">For more information on validators, see the <a href="/3.2/en/validation">Validation documentation</a> </h5>

<p><a name="deleting-records"></a></p>
<h2 id="deleting-records">Deleting Records</h2>
<p>The <code>Phalcon\Mvc\Collection::delete()</code> method allows you to delete a document. You can use it as follows:</p>

<pre><code class="language-php">&lt;?php

$robot = Robots::findFirst();

if ($robot !== false) {
    if ($robot-&gt;delete() === false) {
        echo "Sorry, we can't delete the robot right now: \n";

        $messages = $robot-&gt;getMessages();

        foreach ($messages as $message) {
            echo $message, "\n";
        }
    } else {
        echo 'The robot was deleted successfully!';
    }
}
</code></pre>

<p>You can also delete many documents by traversing a resultset with a <code>foreach</code> loop:</p>

<pre><code class="language-php">&lt;?php

$robots = Robots::find(
    [
        [
            'type' =&gt; 'mechanical',
        ]
    ]
);

foreach ($robots as $robot) {
    if ($robot-&gt;delete() === false) {
        echo "Sorry, we can't delete the robot right now: \n";

        $messages = $robot-&gt;getMessages();

        foreach ($messages as $message) {
            echo $message, "\n";
        }
    } else {
        echo 'The robot was deleted successfully!';
    }
}
</code></pre>

<p>The following events are available to define custom business rules that can be executed when a delete operation is performed:</p>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Name</th>
      <th>Can stop operation?</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Deleting</td>
      <td><code>beforeDelete</code></td>
      <td>YES</td>
      <td>Runs before the delete operation is made</td>
    </tr>
    <tr>
      <td>Deleting</td>
      <td><code>afterDelete</code></td>
      <td>NO</td>
      <td>Runs after the delete operation was made</td>
    </tr>
  </tbody>
</table>

<p><a name="validation-failed-events"></a></p>
<h2 id="validation-failed-events">Validation Failed Events</h2>
<p>Another type of events is available when the data validation process finds any inconsistency:</p>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Name</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Insert or Update</td>
      <td><code>notSave</code></td>
      <td>Triggered when the insert/update operation fails for any reason</td>
    </tr>
    <tr>
      <td>Insert, Delete or Update</td>
      <td><code>onValidationFails</code></td>
      <td>Triggered when any data manipulation operation fails</td>
    </tr>
  </tbody>
</table>

<p><a name="ids-vs-primary-keys"></a></p>
<h2 id="implicit-ids-vs-user-primary-keys">Implicit Ids vs. User Primary Keys</h2>
<p>By default <a href="api/Phalcon_Mvc_Collection">Phalcon\Mvc\Collection</a> assumes that the <code>_id</code> attribute is automatically generated using <a href="http://www.php.net/manual/en/class.mongoid.php">MongoIds</a>.</p>

<p>If a model uses custom primary keys this behavior can be overridden:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function initialize()
    {
        $this-&gt;useImplicitObjectIds(false);
    }
}
</code></pre>

<p><a name="multiple-databases"></a></p>
<h2 id="setting-multiple-databases">Setting multiple databases</h2>
<p>In Phalcon, all models can share the same database connection or specify a connection per model. Actually, when <code>Phalcon\Mvc\Collection</code> needs to connect to the database it requests the <code>mongo</code> service in the application’s services container. You can overwrite this service by setting it in the <code>initialize()</code> method:</p>

<pre><code class="language-php">&lt;?php

// This service returns a mongo database at 192.168.1.100
$di-&gt;set(
    'mongo1',
    function () {
        $mongo = new MongoClient(
            'mongodb://scott:nekhen@192.168.1.100'
        );

        return $mongo-&gt;selectDB('management');
    },
    true
);

// This service returns a mongo database at localhost
$di-&gt;set(
    'mongo2',
    function () {
        $mongo = new MongoClient(
            'mongodb://localhost'
        );

        return $mongo-&gt;selectDB('invoicing');
    },
    true
);
</code></pre>

<p>Then, in the <code>initialize()</code> method, we define the connection service for the model:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function initialize()
    {
        $this-&gt;setConnectionService('mongo1');
    }
}
</code></pre>

<p><a name="services-in-models"></a></p>
<h2 id="injecting-services-into-models">Injecting services into Models</h2>
<p>You may be required to access the application services within a model, the following example explains how to do that:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Collection;

class Robots extends Collection
{
    public function notSave()
    {
        // Obtain the flash service from the DI container
        $flash = $this-&gt;getDI()-&gt;getShared('flash');

        $messages = $this-&gt;getMessages();

        // Show validation messages
        foreach ($messages as $message) {
            $flash-&gt;error(
                (string) $message
            );
        }
    }
}
</code></pre>

<p>The <code>notSave</code> event is triggered whenever a <code>creating</code> or <code>updating</code> action fails. We’re flashing the validation messages obtaining the <code>flash</code> service from the DI container. By doing this, we don’t have to print messages after each saving.</p>

                                    </div>
                                    <div class="col-md-4 col-lg-3 col-sm-12 support-column-margin">
                                        <div class="topic-search">
    <form class="bd-search d-flex align-items-center">
        <input type="search"
               class="form-control"
               id="docs-search"
               placeholder=""
               aria-label=""
               autocomplete="off"
               data-siteurl="https://phalcon-docs4.netlify.com"
               data-docs-version="3.2">
        <button class="btn btn-link bd-search-docs-toggle d-md-none p-0 ml-3"
                type="button"
                data-toggle="collapse"
                data-target="#bd-docs-nav"
                aria-controls="bd-docs-nav"
                aria-expanded="false"
                aria-label="Toggle docs navigation">
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewbox="0 0 30 30"
                 width="30"
                 height="30"
                 focusable="false">
                <title>Menu</title>
                <path stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-miterlimit="10"
                      d="M4 7h22M4 15h22M4 23h22"></path>
            </svg>
        </button>
    </form>
</div>
                                        <div class="topic-categories">
    
</div>

                                        <div class="article-menu">
    <ul>
        
        
    </ul>
</div>
                                    </div>
                                </div>
                            </div>
                        </section>

                    </div>
                </div>
            </div>
        </div>
    </div>

<footer>
    <div class="container">
        <div class="footer-wrapper clearfix">

            <div class="footer-link-container">
                <a class="footer-link" href="/">
                    <img class="footer-logo-img" src="/assets/images/footer_logo.svg" alt="logo">
                </a>
                <a class="footer-link" href="https://phalcon.link/about" target="_blank">
                    
                </a>
                <a class="footer-link" href="https://phalcon.link/sponsors" target="_blank">
                    
                </a>
                <a class="footer-link" href="https://phalcon.link/fund" target="_blank">
                    
                </a>
                <a class="footer-link" href="https://phalcon.link/download" target="_blank">
                    
                </a>
                <a class="footer-link" href="https://license.phalconphp.com/" target="_blank">
                     New BSD
                </a>
            </div>

            <div class="footer-copyright">
                <a href="https://odva.pro/" target="_blank" class="o2-link">
                    <span></span> <img src="/assets/images/logo-o2.svg" alt="logo o2">
                </a>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript" src="/assets/js/main.min.js?v1547266080100021829"></script>
<script type="text/javascript" src="/assets/js/highlight/highlight.pack.js?v1547266080100021829"></script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
</body>
</html>
