<!doctype html>
<!--[if IE 8]>
<html lang="zh-cn" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="zh-cn" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh-cn" class="no-js">
<!--<![endif]-->








    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script type="text/javascript" src="/assets/js/viewport-min-width.js?v1547319779866581049"></script>
        <meta name="description"
              content="Official Phalcon Documentation">
        <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework, php extension, next generation framework, docs, documentation">
        <meta name="author" href="/humans.txt">
        <meta name="generator" content="Phalcon Team - Jekyll - Netlify">

        <link href="http://0.0.0.0:4000/3.4/zh-cn/db-phql.html" rel="canonical">
        <title>Phalcon Framework Documentation</title>

        <!-- Twitter -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@zephirlang">
        <meta name="twitter:creator" content="@zephirlang">
        <meta name="twitter:title" content="Phalcon Framework Documentation">
        <meta name="twitter:description" content="Official Phalcon Documentation">
        <meta name="twitter:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <!-- Facebook -->
        <meta property="og:url" content="http://0.0.0.0:4000">
        <meta property="og:title" content="Phalcon Framework Documentation">
        <meta property="og:description" content="Official Phalcon Documentation">
        <meta property="og:type" content="website">
        <meta property="og:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <meta name="msapplication-TileColor" content="#FFFFFF">
        <meta name="msapplication-square70x70logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-70x70.png">
        <meta name="msapplication-TileImage"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-144x144.png">
        <meta name="msapplication-square150x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-150x150.png">
        <meta name="msapplication-wide310x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x150.png">
        <meta name="msapplication-square310x310logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x310.png">

        <link rel="apple-touch-icon"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon.png">

        <link rel="apple-touch-icon-precomposed"
              sizes="57x57"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="60x60"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="72x72"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="76x76"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="114x114"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="120x120"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="144x144"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="152x152"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-152x152.png">

        <link rel="icon"
              type="image/png"
              sizes="16x16"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-16x16.png">
        <link rel="icon"
              type="image/png"
              sizes="32x32"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-32x32.png">
        <link rel="icon"
              type="image/png"
              sizes="96x96"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-96x96.png">
        <link rel="icon"
              type="image/png"
              sizes="128x128"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-128x128.png">
        <link rel="icon"
              type="image/png"
              sizes="196x196"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-196x196.png">
        <link rel="shortcut icon"
              type="image/png"
              href="https://assets.phalconphp.com/phalcon/favicon.ico"/>

        <link rel="alternate"
              type="application/rss+xml"
              title=" - "
              href="http://0.0.0.0:4000/feed.xml">

        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"
              integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE="
              crossorigin="anonymous" />
        <link rel="stylesheet" href="/assets/css/monokai.css?v1547319779866581049" />
        <link rel="stylesheet" href="/assets/css/style.css?v1547319779866581049" />

        <script defer src="https://use.fontawesome.com/releases/v5.6.1/js/all.js"
                integrity="sha384-R5JkiUweZpJjELPWqttAYmYM1P3SNEJRM6ecTQF05pFFtxmCO+Y1CiUhvuDzgSVZ"
                crossorigin="anonymous"></script>
        
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90300500-6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90300500-6');
    </script>

    </head>


<body onclick="o2.allNavSlideUp()">
    <header class="header-image-doc">
        <div class="container">
            <div class="header-wrapper">
                <div class="clearfix">
                    <div class="row">
                        <div class="col-md-2 col-sm-3  col-xs-8">
                            <div class="header-image__logo-wrapper">
                                <a href="/3.4/zh-cn">
                                    <img class="logo-img" src="/assets/images/header_logo.svg" alt="logo">
                                </a>
                            </div>
                        </div>
                        <div class="col-md-10 col-sm-9 top-menu">

                            <div class="nav-icon" onclick="o2.showMobileMenu();">
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                            </div>
                            <nav class="header-nav">
                                <ul>
                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                                 alt="">
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list" onclick="event.stopPropagation();">
                                            
                                                <a href="/3.4/en/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                         alt="English (US)">
                                                    English (US)
                                                </a>
                                            
                                                <a href="/3.4/cs-cz/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/cs.png"
                                                         alt="Czech">
                                                    Czech
                                                </a>
                                            
                                                <a href="/3.4/de-de/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/de.png"
                                                         alt="German">
                                                    German
                                                </a>
                                            
                                                <a href="/3.4/es-es/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/es-ES.png"
                                                         alt="Spanish">
                                                    Spanish
                                                </a>
                                            
                                                <a href="/3.4/fa-ir/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fa.png"
                                                         alt="Persian">
                                                    Persian
                                                </a>
                                            
                                                <a href="/3.4/fr-fr/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fr.png"
                                                         alt="French">
                                                    French
                                                </a>
                                            
                                                <a href="/3.4/id-id/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/id.png"
                                                         alt="Indonesian">
                                                    Indonesian
                                                </a>
                                            
                                                <a href="/3.4/it-it/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/it.png"
                                                         alt="Italian">
                                                    Italian
                                                </a>
                                            
                                                <a href="/3.4/ja-jp/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                                         alt="Japanese">
                                                    Japanese
                                                </a>
                                            
                                                <a href="/3.4/pl-pl/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/pl.png"
                                                         alt="Polish">
                                                    Polish
                                                </a>
                                            
                                                <a href="/3.4/ru-ru/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ru.png"
                                                         alt="Russian">
                                                    Russian
                                                </a>
                                            
                                                <a href="/3.4/tr-tr/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/tr.png"
                                                         alt="Turkish">
                                                    Turkish
                                                </a>
                                            
                                                <a href="/3.4/uk-ua/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/uk.png"
                                                         alt="Ukrainian">
                                                    Ukrainian
                                                </a>
                                            
                                                <a href="/3.4/zh-cn/db-phql" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                                         alt="Chinese Simplified">
                                                    Chinese Simplified
                                                </a>
                                            
                                        </div>
                                    </li>

                                        <li class="nav-item" onclick="o2.toggleState(this, event);">
                                            <div class="nav-item__selected custom-select__version">
                                                Version 3.4
                                                <span class="caret"></span>
                                            </div>
                                            <div class="nav-item__list" onclick="event.stopPropagation();">
                                                
                                                <a href="/3.4/zh-cn/db-phql" class="custom-select__list-item">
                                                    <span>3.4</span>
                                                </a>
                                                
                                                <a href="/3.3/zh-cn/db-phql" class="custom-select__list-item">
                                                    <span>3.3</span>
                                                </a>
                                                
                                                <a href="/3.2/zh-cn/db-phql" class="custom-select__list-item">
                                                    <span>3.2</span>
                                                </a>
                                                
                                                <a href="/3.1/zh-cn/db-phql" class="custom-select__list-item">
                                                    <span>3.1</span>
                                                </a>
                                                
                                                <a href="/4.0/zh-cn/db-phql" class="custom-select__list-item">
                                                    <span>4.0</span>
                                                </a>
                                                
                                            </div>
                                        </li>

                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            Community
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list">
                                            <a href="https://phalcon.link/forum" class="custom-select__list-item" target="_blank">
                                                Forum
                                            </a>
                                            <a href="https://phalcon.link/blog" class="custom-select__list-item" target="_blank">
                                                Blog
                                            </a>
                                            <a href="https://phalcon.link/resources" class="custom-select__list-item" target="_blank">
                                                Resources
                                            </a>
                                            <div class="nav-item__divider"></div>
                                            <a href="https://phalcon.link/f" class="custom-select__list-item" target="_blank">
                                                Facebook
                                            </a>
                                            <a href="https://phalcon.link/t" class="custom-select__list-item" target="_blank">
                                                Twitter
                                            </a>
                                            <a href="https://phalcon.link/gab" class="custom-select__list-item" target="_blank">
                                                Gab.ai
                                            </a>
                                        </div>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/about">
                                            About
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/sponsors">
                                            Sponsors
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/fund">
                                            Support Us
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/download">
                                            Download
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                        <div class="header-nav-mobile">
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    <img class="lang-image"
                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                         alt="">
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/en/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                 alt="English (US)">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/cs-cz/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/cs.png"
                                                 alt="Czech">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/de-de/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/de.png"
                                                 alt="German">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/es-es/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/es-ES.png"
                                                 alt="Spanish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/fa-ir/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fa.png"
                                                 alt="Persian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/fr-fr/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fr.png"
                                                 alt="French">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/id-id/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/id.png"
                                                 alt="Indonesian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/it-it/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/it.png"
                                                 alt="Italian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/ja-jp/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                                 alt="Japanese">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/pl-pl/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/pl.png"
                                                 alt="Polish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/ru-ru/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ru.png"
                                                 alt="Russian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/tr-tr/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/tr.png"
                                                 alt="Turkish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/uk-ua/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/uk.png"
                                                 alt="Ukrainian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/zh-cn/db-phql">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                                 alt="Chinese Simplified">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this,event)">
                                    Version 3.4
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.4/zh-cn/db-phql">
                                            <span>3.4</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.3/zh-cn/db-phql">
                                            <span>3.3</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.2/zh-cn/db-phql">
                                            <span>3.2</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.1/zh-cn/db-phql">
                                            <span>3.1</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/4.0/zh-cn/db-phql">
                                            <span>4.0</span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    
                                    <span class="caret"></span>
                                </div>
                                <ul style="display:none;">
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/forum" target="_blank">
                                            Forum
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/blog" target="_blank">
                                            Blog
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/resources" target="_blank">
                                            Resources
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/f" target="_blank">
                                            Facebook
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/t" target="_blank">
                                            Twitter
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/gab" target="_blank">
                                            Gab.ai
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/about">
                                    About
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/sponsors">
                                    Sponsors
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/fund">
                                    Support Us
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/download">
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <div class="container-fluid article-page-wrap">
        <div class="row">
            <div>
                <div class="col-md-2 sidebar hidden-xs">
                    <div class="sidebar--spacer">&nbsp;</div>
                </div>
                <div class="m-t-md m-b-lg" id="articles">
                    <div class="article-content">
                        <p><a name="overview"></a></p>

<h1 id="phalcon的查询语言-phql">Phalcon的查询语言 (PHQL)</h1>

<p>Phalcon查询语言、PhalconQL或简单的PHQL是一种高级的、面向对象的SQL方言，允许使用标准化的类似SQL的语言编写查询。 PHQL实现为解析器(用C语言编写)，将语法转换为目标RDBMS的语法。</p>

<p>为了实现尽可能高的性能, phalcon 提供了一个使用与 <a href="http://en.wikipedia.org/wiki/Lemon_Parser_Generator">SQLite</a> 相同技术的解析器。 这项技术提供了一个小的内存解析器, 内存占用非常低, 也是线程安全的。</p>

<p>解析器首先检查 pass PHQL 语句的语法, 然后生成语句的中间表示形式, 最后将其转换为目标 rdbms 的相应 sql 方言。</p>

<p>在 PHQL 中, 我们实现了一组功能, 使您对数据库的访问更加安全:</p>

<ul>
  <li>绑定参数是 PHQL语言的一部分, 可帮助您保护代码</li>
  <li>PHQL只允许每个调用执行一个 sql 语句, 以防止注入</li>
  <li>PHQL忽略 sql 注入中经常使用的所有 sql 注释</li>
  <li>PHQL只允许数据操作语句, 避免错误地更改或删除表数据库或未经授权在外部更改或删除</li>
  <li>PHQL 实现了一个高级抽象, 允许您将表作为模型处理, 将字段作为类属性处理</li>
</ul>

<p><a name="usage"></a></p>

<h2 id="用法示例">用法示例</h2>

<p>To better explain how PHQL works consider the following example. We have two models <code>Cars</code> and <code>Brands</code>:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;

class Cars extends Model
{
    public $id;

    public $name;

    public $brand_id;

    public $price;

    public $year;

    public $style;

    /**
     * This model is mapped to the table sample_cars
     */
    public function getSource()
    {
        return 'sample_cars';
    }

    /**
     * A car only has a Brand, but a Brand have many Cars
     */
    public function initialize()
    {
        $this-&gt;belongsTo('brand_id', 'Brands', 'id');
    }
}
</code></pre>

<p>每辆车都有一个品牌，所以一个品牌有很多车:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;

class Brands extends Model
{
    public $id;

    public $name;

    /**
     * The model Brands is mapped to the 'sample_brands' table
     */
    public function getSource()
    {
        return 'sample_brands';
    }

    /**
     * A Brand can have many Cars
     */
    public function initialize()
    {
        $this-&gt;hasMany('id', 'Cars', 'brand_id');
    }
}
</code></pre>

<p><a name="creating"></a></p>

<h2 id="创建-phql-查询">创建 PHQL 查询</h2>

<p>PHQL queries can be created just by instantiating the class <a href="api/Phalcon_Mvc_Model_Query">Phalcon\Mvc\Model\Query</a>:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model\Query;

// 实例化查询
$query = new Query(
    'SELECT * FROM Cars',
    $this-&gt;getDI()
);

// 执行返回任何结果的查询
$cars = $query-&gt;execute();
</code></pre>

<p>From a controller or a view, it’s easy to create/execute them using an injected <code>models manager</code> (<a href="api/Phalcon_Mvc_Model_Manager">Phalcon\Mvc\Model\Manager</a>):</p>

<pre><code class="language-php">&lt;?php

// Executing a simple query
$query = $this-&gt;modelsManager-&gt;createQuery('SELECT * FROM Cars');
$cars  = $query-&gt;execute();

// With bound parameters
$query = $this-&gt;modelsManager-&gt;createQuery('SELECT * FROM Cars WHERE name = :name:');
$cars  = $query-&gt;execute(
    [
        'name' =&gt; 'Audi',
    ]
);
</code></pre>

<p>或者简单地执行:</p>

<pre><code class="language-php">&lt;?php

// Executing a simple query
$cars = $this-&gt;modelsManager-&gt;executeQuery(
    'SELECT * FROM Cars'
);

// Executing with bound parameters
$cars = $this-&gt;modelsManager-&gt;executeQuery(
    'SELECT * FROM Cars WHERE name = :name:',
    [
        'name' =&gt; 'Audi',
    ]
);
</code></pre>

<p><a name="selecting-records"></a></p>

<h2 id="查询记录">查询记录</h2>

<p>作为熟悉的SQL, PHQL允许使用我们知道的SELECT语句查询记录，除了我们使用模型类而不是指定表:</p>

<pre><code class="language-php">&lt;?php

$query = $manager-&gt;createQuery(
    'SELECT * FROM Cars ORDER BY Cars.name'
);

$query = $manager-&gt;createQuery(
    'SELECT Cars.name FROM Cars ORDER BY Cars.name'
);
</code></pre>

<p>名称空间中的类也被允许:</p>

<pre><code class="language-php">&lt;?php

$phql  = 'SELECT * FROM Formula\Cars ORDER BY Formula\Cars.name';
$query = $manager-&gt;createQuery($phql);

$phql  = 'SELECT Formula\Cars.name FROM Formula\Cars ORDER BY Formula\Cars.name';
$query = $manager-&gt;createQuery($phql);

$phql  = 'SELECT c.name FROM Formula\Cars c ORDER BY c.name';
$query = $manager-&gt;createQuery($phql);
</code></pre>

<p>大多数SQL标准都由PHQL支持，甚至是非标准指令，如LIMIT:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT c.name FROM Cars AS c WHERE c.brand_id = 21 ORDER BY c.name LIMIT 100';

$query = $manager-&gt;createQuery($phql);
</code></pre>

<p><a name="result-types"></a></p>

<h3 id="结果类型">结果类型</h3>

<p>根据我们查询的列的类型，结果类型会有所不同。 If you retrieve a single whole object, then the object returned is a <a href="api/Phalcon_Mvc_Model_Resultset_Simple">Phalcon\Mvc\Model\Resultset\Simple</a>. 这种resultset是一组完整的模型对象:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT c.* FROM Cars AS c ORDER BY c.name';

$cars = $manager-&gt;executeQuery($phql);

foreach ($cars as $car) {
    echo 'Name: ', $car-&gt;name, "\n";
}
</code></pre>

<p>这与:</p>

<pre><code class="language-php">&lt;?php

$cars = Cars::find(
    [
        'order' =&gt; 'name'
    ]
);

foreach ($cars as $car) {
    echo 'Name: ', $car-&gt;name, "\n";
}
</code></pre>

<p>完整的对象可以被修改并重新保存在数据库中，因为它们表示关联表的完整记录。 还有其他类型的查询不返回完整的对象，例如:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT c.id, c.name FROM Cars AS c ORDER BY c.name';

$cars = $manager-&gt;executeQuery($phql);

foreach ($cars as $car) {
    echo 'Name: ', $car-&gt;name, "\n";
}
</code></pre>

<p>We are only requesting some fields in the table, therefore those cannot be considered an entire object, so the returned object is still a resultset of type <a href="api/Phalcon_Mvc_Model_Resultset_Simple">Phalcon\Mvc\Model\Resultset\Simple</a>. 但是，每个元素都是一个标准对象，只包含请求的两列。</p>

<p>These values that don’t represent complete objects are what we call scalars. PHQL allows you to query all types of scalars: fields, functions, literals, expressions, etc..:</p>

<pre><code class="language-php">&lt;?php

$phql = "SELECT CONCAT(c.id, ' ', c.name) AS id_name FROM Cars AS c ORDER BY c.name";

$cars = $manager-&gt;executeQuery($phql);

foreach ($cars as $car) {
    echo $car-&gt;id_name, "\n";
}
</code></pre>

<p>因为我们可以查询完整的对象或标量，我们也可以同时查询:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT c.price*0.16 AS taxes, c.* FROM Cars AS c ORDER BY c.name';

$result = $manager-&gt;executeQuery($phql);
</code></pre>

<p>The result in this case is an object <a href="api/Phalcon_Mvc_Model_Resultset_Complex">Phalcon\Mvc\Model\Resultset\Complex</a>. This allows access to both complete objects and scalars at once:</p>

<pre><code class="language-php">&lt;?php

foreach ($result as $row) {
    echo 'Name: ', $row-&gt;cars-&gt;name, "\n";
    echo 'Price: ', $row-&gt;cars-&gt;price, "\n";
    echo 'Taxes: ', $row-&gt;taxes, "\n";
}
</code></pre>

<p>”标量映射为每个“行”的属性，而完整对象映射为具有相关模型名称的属性。</p>

<p><a name="joins"></a></p>

<h3 id="joins">Joins</h3>

<p>It’s easy to request records from multiple models using PHQL. Most kinds of Joins are supported. As we defined relationships in the models, PHQL adds these conditions automatically:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Cars.name AS car_name, Brands.name AS brand_name FROM Cars JOIN Brands';

$rows = $manager-&gt;executeQuery($phql);

foreach ($rows as $row) {
    echo $row-&gt;car_name, "\n";
    echo $row-&gt;brand_name, "\n";
}
</code></pre>

<p>By default, an INNER JOIN is assumed. You can specify the type of JOIN in the query:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Cars.*, Brands.* FROM Cars INNER JOIN Brands';
$rows = $manager-&gt;executeQuery($phql);

$phql = 'SELECT Cars.*, Brands.* FROM Cars LEFT JOIN Brands';
$rows = $manager-&gt;executeQuery($phql);

$phql = 'SELECT Cars.*, Brands.* FROM Cars LEFT OUTER JOIN Brands';
$rows = $manager-&gt;executeQuery($phql);

$phql = 'SELECT Cars.*, Brands.* FROM Cars CROSS JOIN Brands';
$rows = $manager-&gt;executeQuery($phql);
</code></pre>

<p>也可以手动设置连接的条件:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Cars.*, Brands.* FROM Cars INNER JOIN Brands ON Brands.id = Cars.brands_id';

$rows = $manager-&gt;executeQuery($phql);
</code></pre>

<p>另外，可以使用FROM子句中的多个表创建连接:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Cars.*, Brands.* FROM Cars, Brands WHERE Brands.id = Cars.brands_id';

$rows = $manager-&gt;executeQuery($phql);

foreach ($rows as $row) {
    echo 'Car: ', $row-&gt;cars-&gt;name, "\n";
    echo 'Brand: ', $row-&gt;brands-&gt;name, "\n";
}
</code></pre>

<p>如果一个别名用于重命名查询中的模型，那么这些别名将用于命名结果的每一行中的属性:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT c.*, b.* FROM Cars c, Brands b WHERE b.id = c.brands_id';

$rows = $manager-&gt;executeQuery($phql);

foreach ($rows as $row) {
    echo 'Car: ', $row-&gt;c-&gt;name, "\n";
    echo 'Brand: ', $row-&gt;b-&gt;name, "\n";
}
</code></pre>

<p>当连接的模型与模型有多对多关系时，中间模型隐式地添加到生成的查询中:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Artists.name, Songs.name FROM Artists ' .
        'JOIN Songs WHERE Artists.genre = "Trip-Hop"';

$result = $this-&gt;modelsManager-&gt;executeQuery($phql);
</code></pre>

<p>此代码在MySQL中执行以下SQL:</p>

<pre><code class="language-sql">SELECT `artists`.`name`, `songs`.`name` FROM `artists`
INNER JOIN `albums` ON `albums`.`artists_id` = `artists`.`id`
INNER JOIN `songs` ON `albums`.`songs_id` = `songs`.`id`
WHERE `artists`.`genre` = 'Trip-Hop'
</code></pre>

<p><a name="aggregations"></a></p>

<h3 id="聚合">聚合</h3>

<p>下面的例子展示了如何在PHQL中使用聚合:</p>

<pre><code class="language-php">&lt;?php

// 所有汽车的价格是多少?
$phql = 'SELECT SUM(price) AS summatory FROM Cars';
$row  = $manager-&gt;executeQuery($phql)-&gt;getFirst();
echo $row['summatory'];

// 每个品牌有多少辆车?
$phql = 'SELECT Cars.brand_id, COUNT(*) FROM Cars GROUP BY Cars.brand_id';
$rows = $manager-&gt;executeQuery($phql);
foreach ($rows as $row) {
    echo $row-&gt;brand_id, ' ', $row['1'], "\n";
}

// 每个品牌有多少辆车?
$phql = 'SELECT Brands.name, COUNT(*) FROM Cars JOIN Brands GROUP BY 1';
$rows = $manager-&gt;executeQuery($phql);
foreach ($rows as $row) {
    echo $row-&gt;name, ' ', $row['1'], "\n";
}

$phql = 'SELECT MAX(price) AS maximum, MIN(price) AS minimum FROM Cars';
$rows = $manager-&gt;executeQuery($phql);
foreach ($rows as $row) {
    echo $row['maximum'], ' ', $row['minimum'], "\n";
}

// 统计不同的品牌
$phql = 'SELECT COUNT(DISTINCT brand_id) AS brandId FROM Cars';
$rows = $manager-&gt;executeQuery($phql);
foreach ($rows as $row) {
    echo $row-&gt;brandId, "\n";
}
</code></pre>

<p><a name="conditions"></a></p>

<h3 id="条件">条件</h3>

<p>Conditions allow us to filter the set of records we want to query. The <code>WHERE</code> clause allows to do that:</p>

<pre><code class="language-php">&lt;?php

// Simple conditions
$phql = 'SELECT * FROM Cars WHERE Cars.name = "Lamborghini Espada"';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.price &gt; 10000';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE TRIM(Cars.name) = "Audi R8"';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.name LIKE "Ferrari%"';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.name NOT LIKE "Ferrari%"';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.price IS NULL';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.id IN (120, 121, 122)';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.id NOT IN (430, 431)';
$cars = $manager-&gt;executeQuery($phql);

$phql = 'SELECT * FROM Cars WHERE Cars.id BETWEEN 1 AND 100';
$cars = $manager-&gt;executeQuery($phql);
</code></pre>

<p>同时，作为PHQL的一部分，准备的参数会自动转义输入数据，引入更多的安全性:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT * FROM Cars WHERE Cars.name = :name:';
$cars = $manager-&gt;executeQuery(
    $phql,
    [
        'name' =&gt; 'Lamborghini Espada'
    ]
);

$phql = 'SELECT * FROM Cars WHERE Cars.name = ?0';
$cars = $manager-&gt;executeQuery(
    $phql,
    [
        0 =&gt; 'Lamborghini Espada'
    ]
);
</code></pre>

<p><a name="inserting-data"></a></p>

<h2 id="插入数据">插入数据</h2>

<p>使用PHQL，可以使用熟悉的insert语句插入数据:</p>

<pre><code class="language-php">&lt;?php

// Inserting without columns
$phql = 'INSERT INTO Cars VALUES (NULL, "Lamborghini Espada", '
      . '7, 10000.00, 1969, "Grand Tourer")';
$manager-&gt;executeQuery($phql);

// Specifying columns to insert
$phql = 'INSERT INTO Cars (name, brand_id, year, style) '
      . 'VALUES ("Lamborghini Espada", 7, 1969, "Grand Tourer")';
$manager-&gt;executeQuery($phql);

// Inserting using placeholders
$phql = 'INSERT INTO Cars (name, brand_id, year, style) '
      . 'VALUES (:name:, :brand_id:, :year:, :style)';
$manager-&gt;executeQuery(
    $phql,
    [
        'name'     =&gt; 'Lamborghini Espada',
        'brand_id' =&gt; 7,
        'year'     =&gt; 1969,
        'style'    =&gt; 'Grand Tourer',
    ]
);
</code></pre>

<p>Phalcon不只是将PHQL语句转换成SQL。 模型中定义的所有事件和业务规则都像手动创建单个对象一样执行。 让我们在模型汽车上添加一个业务规则。 一辆车的价格不能低于1万美元:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Message;

class Cars extends Model
{
    public function beforeCreate()
    {
        if ($this-&gt;price &lt; 10000) {
            $this-&gt;appendMessage(
                new Message('A car cannot cost less than $ 10,000')
            );

            return false;
        }
    }
}
</code></pre>

<p>如果我们在Cars模型中插入以下<code>INSERT</code>，操作将不会成功，因为价格不符合我们实现的业务规则。 通过检查插入的状态，我们可以打印内部生成的任何验证消息:</p>

<pre><code class="language-php">&lt;?php

$phql = "INSERT INTO Cars VALUES (NULL, 'Nissan Versa', 7, 9999.00, 2015, 'Sedan')";

$result = $manager-&gt;executeQuery($phql);

if ($result-&gt;success() === false) {
    foreach ($result-&gt;getMessages() as $message) {
        echo $message-&gt;getMessage();
    }
}
</code></pre>

<p><a name="updating-data"></a></p>

<h2 id="更新数据">更新数据</h2>

<p>更新行与插入行非常相似。 您可能知道，更新记录的指令是UPDATE。 当一条记录被更新时，将对每一行执行与更新操作相关的事件。</p>

<pre><code class="language-php">&lt;?php

// Updating a single column
$phql = 'UPDATE Cars SET price = 15000.00 WHERE id = 101';
$manager-&gt;executeQuery($phql);

// Updating multiples columns
$phql = 'UPDATE Cars SET price = 15000.00, type = "Sedan" WHERE id = 101';
$manager-&gt;executeQuery($phql);

// Updating multiples rows
$phql = 'UPDATE Cars SET price = 7000.00, type = "Sedan" WHERE brands_id &gt; 5';
$manager-&gt;executeQuery($phql);

// Using placeholders
$phql = 'UPDATE Cars SET price = ?0, type = ?1 WHERE brands_id &gt; ?2';
$manager-&gt;executeQuery(
    $phql,
    [
        0 =&gt; 7000.00,
        1 =&gt; 'Sedan',
        2 =&gt; 5,
    ]
);
</code></pre>

<p>一个<code>UPDATE</code>语句执行两个阶段的更新:</p>

<ul>
  <li>首先，如果<code>UPDATE</code>具有<code>WHERE</code>子句检索所有符合这些条件的对象，</li>
  <li>其次，基于查询对象，它更新/更改将其存储到关系数据库的请求属性</li>
</ul>

<p>This way of operation allows that events, virtual foreign keys and validations take part of the updating process. In summary, the following code:</p>

<pre><code class="language-php">&lt;?php

$phql = 'UPDATE Cars SET price = 15000.00 WHERE id &gt; 101';

$result = $manager-&gt;executeQuery($phql);

if ($result-&gt;success() === false) {
    $messages = $result-&gt;getMessages();

    foreach ($messages as $message) {
        echo $message-&gt;getMessage();
    }
}
</code></pre>

<p>相当于:</p>

<pre><code class="language-php">&lt;?php

$messages = null;

$process = function () use (&amp;$messages) {
    $cars = Cars::find('id &gt; 101');

    foreach ($cars as $car) {
        $car-&gt;price = 15000;

        if ($car-&gt;save() === false) {
            $messages = $car-&gt;getMessages();

            return false;
        }
    }

    return true;
};

$success = $process();
</code></pre>

<p><a name="deleting-data"></a></p>

<h2 id="删除数据">删除数据</h2>

<p>当一个记录被删除时，与删除操作相关的事件将对每一行执行:</p>

<pre><code class="language-php">&lt;?php

// Deleting a single row
$phql = 'DELETE FROM Cars WHERE id = 101';
$manager-&gt;executeQuery($phql);

// Deleting multiple rows
$phql = 'DELETE FROM Cars WHERE id &gt; 100';
$manager-&gt;executeQuery($phql);

// Using placeholders
$phql = 'DELETE FROM Cars WHERE id BETWEEN :initial: AND :final:';
$manager-&gt;executeQuery(
    $phql,
    [
        'initial' =&gt; 1,
        'final'   =&gt; 100,
    ]
);
</code></pre>

<p><code>DELETE</code> operations are also executed in two phases like <code>UPDATEs</code>. To check if the deletion produces any validation messages you should check the status code returned:</p>

<pre><code class="language-php">&lt;?php

// Deleting multiple rows
$phql = 'DELETE FROM Cars WHERE id &gt; 100';

$result = $manager-&gt;executeQuery($phql);

if ($result-&gt;success() === false) {
    $messages = $result-&gt;getMessages();

    foreach ($messages as $message) {
        echo $message-&gt;getMessage();
    }
}
</code></pre>

<p><a name="query-builder"></a></p>

<h2 id="使用查询生成器创建查询">使用查询生成器创建查询</h2>

<p>构建器可以创建PHQL查询，而不需要编写PHQL语句，还提供IDE工具:</p>

<pre><code class="language-php">&lt;?php

// Getting a whole set
$robots = $this-&gt;modelsManager-&gt;createBuilder()
    -&gt;from('Robots')
    -&gt;join('RobotsParts')
    -&gt;orderBy('Robots.name')
    -&gt;getQuery()
    -&gt;execute();

// Getting the first row
$robots = $this-&gt;modelsManager-&gt;createBuilder()
    -&gt;from('Robots')
    -&gt;join('RobotsParts')
    -&gt;orderBy('Robots.name')
    -&gt;getQuery()
    -&gt;getSingleResult();
</code></pre>

<p>这等于:</p>

<pre><code class="language-php">&lt;?php

$phql = 'SELECT Robots.* FROM Robots JOIN RobotsParts p ORDER BY Robots.name LIMIT 20';

$result = $manager-&gt;executeQuery($phql);
</code></pre>

<p>更多的构建器例子:</p>

<pre><code class="language-php">&lt;?php

// 'SELECT Robots.* FROM Robots';
$builder-&gt;from('Robots');

// 'SELECT Robots.*, RobotsParts.* FROM Robots, RobotsParts';
$builder-&gt;from(
    [
        'Robots',
        'RobotsParts',
    ]
);

// 'SELECT * FROM Robots';
$phql = $builder-&gt;columns('*')
                -&gt;from('Robots');

// 'SELECT id FROM Robots';
$builder-&gt;columns('id')
        -&gt;from('Robots');

// 'SELECT id, name FROM Robots';
$builder-&gt;columns(['id', 'name'])
        -&gt;from('Robots');

// 'SELECT Robots.* FROM Robots WHERE Robots.name = 'Voltron'';
$builder-&gt;from('Robots')
        -&gt;where("Robots.name = 'Voltron'");

// 'SELECT Robots.* FROM Robots WHERE Robots.id = 100';
$builder-&gt;from('Robots')
        -&gt;where(100);

// 'SELECT Robots.* FROM Robots WHERE Robots.type = 'virtual' AND Robots.id &gt; 50';
$builder-&gt;from('Robots')
        -&gt;where("type = 'virtual'")
        -&gt;andWhere('id &gt; 50');

// 'SELECT Robots.* FROM Robots WHERE Robots.type = 'virtual' OR Robots.id &gt; 50';
$builder-&gt;from('Robots')
        -&gt;where("type = 'virtual'")
        -&gt;orWhere('id &gt; 50');

// 'SELECT Robots.* FROM Robots GROUP BY Robots.name';
$builder-&gt;from('Robots')
        -&gt;groupBy('Robots.name');

// 'SELECT Robots.* FROM Robots GROUP BY Robots.name, Robots.id';
$builder-&gt;from('Robots')
        -&gt;groupBy(['Robots.name', 'Robots.id']);

// 'SELECT Robots.name, SUM(Robots.price) FROM Robots GROUP BY Robots.name';
$builder-&gt;columns(['Robots.name', 'SUM(Robots.price)'])
    -&gt;from('Robots')
    -&gt;groupBy('Robots.name');

// 'SELECT Robots.name, SUM(Robots.price) FROM Robots GROUP BY Robots.name HAVING SUM(Robots.price) &gt; 1000';
$builder-&gt;columns(['Robots.name', 'SUM(Robots.price)'])
    -&gt;from('Robots')
    -&gt;groupBy('Robots.name')
    -&gt;having('SUM(Robots.price) &gt; 1000');

// 'SELECT Robots.* FROM Robots JOIN RobotsParts';
$builder-&gt;from('Robots')
    -&gt;join('RobotsParts');

// 'SELECT Robots.* FROM Robots JOIN RobotsParts AS p';
$builder-&gt;from('Robots')
    -&gt;join('RobotsParts', null, 'p');

// 'SELECT Robots.* FROM Robots JOIN RobotsParts ON Robots.id = RobotsParts.robots_id AS p';
$builder-&gt;from('Robots')
    -&gt;join('RobotsParts', 'Robots.id = RobotsParts.robots_id', 'p');

// 'SELECT Robots.* FROM Robots
// JOIN RobotsParts ON Robots.id = RobotsParts.robots_id AS p
// JOIN Parts ON Parts.id = RobotsParts.parts_id AS t';
$builder-&gt;from('Robots')
    -&gt;join('RobotsParts', 'Robots.id = RobotsParts.robots_id', 'p')
    -&gt;join('Parts', 'Parts.id = RobotsParts.parts_id', 't');

// 'SELECT r.* FROM Robots AS r';
$builder-&gt;addFrom('Robots', 'r');

// 'SELECT Robots.*, p.* FROM Robots, Parts AS p';
$builder-&gt;from('Robots')
    -&gt;addFrom('Parts', 'p');

// 'SELECT r.*, p.* FROM Robots AS r, Parts AS p';
$builder-&gt;from(['r' =&gt; 'Robots'])
        -&gt;addFrom('Parts', 'p');

// 'SELECT r.*, p.* FROM Robots AS r, Parts AS p';
$builder-&gt;from(['r' =&gt; 'Robots', 'p' =&gt; 'Parts']);

// 'SELECT Robots.* FROM Robots LIMIT 10';
$builder-&gt;from('Robots')
    -&gt;limit(10);

// 'SELECT Robots.* FROM Robots LIMIT 10 OFFSET 5';
$builder-&gt;from('Robots')
        -&gt;limit(10, 5);

// 'SELECT Robots.* FROM Robots WHERE id BETWEEN 1 AND 100';
$builder-&gt;from('Robots')
        -&gt;betweenWhere('id', 1, 100);

// 'SELECT Robots.* FROM Robots WHERE id IN (1, 2, 3)';
$builder-&gt;from('Robots')
        -&gt;inWhere('id', [1, 2, 3]);

// 'SELECT Robots.* FROM Robots WHERE id NOT IN (1, 2, 3)';
$builder-&gt;from('Robots')
        -&gt;notInWhere('id', [1, 2, 3]);

// 'SELECT Robots.* FROM Robots WHERE name LIKE '%Art%';
$builder-&gt;from('Robots')
        -&gt;where('name LIKE :name:', ['name' =&gt; '%' . $name . '%']);

// 'SELECT r.* FROM Store\Robots WHERE r.name LIKE '%Art%';
$builder-&gt;from(['r' =&gt; 'Store\Robots'])
        -&gt;where('r.name LIKE :name:', ['name' =&gt; '%' . $name . '%']);
</code></pre>

<p><a name="query-builder-parameters"></a></p>

<h3 id="绑定参数">绑定参数</h3>

<p>查询生成器中的绑定参数可以在查询被构造时设置，或者在执行时一次性全部超过:</p>

<pre><code class="language-php">&lt;?php

// Passing parameters in the query construction
$robots = $this-&gt;modelsManager-&gt;createBuilder()
    -&gt;from('Robots')
    -&gt;where('name = :name:', ['name' =&gt; $name])
    -&gt;andWhere('type = :type:', ['type' =&gt; $type])
    -&gt;getQuery()
    -&gt;execute();

// Passing parameters in query execution
$robots = $this-&gt;modelsManager-&gt;createBuilder()
    -&gt;from('Robots')
    -&gt;where('name = :name:')
    -&gt;andWhere('type = :type:')
    -&gt;getQuery()
    -&gt;execute(['name' =&gt; $name, 'type' =&gt; $type]);
</code></pre>

<p><a name="disallow-literals"></a></p>

<h2 id="phql不允许的文字">PHQL不允许的文字</h2>

<p>在PHQL中可以禁用文字，这意味着直接使用字符串、数字和布尔值将被禁用。 如果创建了将外部数据嵌入到PHQL语句上的PHQL语句，这可能会使应用程序面临潜在的SQL注入:</p>

<pre><code class="language-php">&lt;?php

$login  = 'voltron';
$phql   = "SELECT * FROM Models\Users WHERE login = '$login'";
$result = $manager-&gt;executeQuery($phql);
</code></pre>

<p>如果<code>$login</code> 被更改为 <code>' OR '' = '</code>, name生成的PHQL就是:</p>

<pre><code class="language-sql">SELECT * FROM Models\Users WHERE login = '' OR '' = ''
</code></pre>

<p>无论数据库中存储的登录名是什么，它总是<code>true</code>。</p>

<p>如果不允许字面值的字符串可以作为PHQL语句的一部分使用，那么就会抛出一个异常，迫使开发人员使用绑定参数。 可以以安全的方式编写相同的查询, 如下所示:</p>

<pre><code class="language-php">&lt;?php

$type   = 'virtual';
$phql   = 'SELECT Robots.* FROM Robots WHERE Robots.type = :type:';
$result = $manager-&gt;executeQuery(
    $phql,
    [
        'type' =&gt; $type,
    ]
);
</code></pre>

<p>您可以通过以下方式不允许文本:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;

Model::setup(
    [
        'phqlLiterals' =&gt; false
    ]
);
</code></pre>

<p>Bound parameters can be used even if literals are allowed or not. Disallowing them is just another security decision a developer could take in web applications.</p>

<p><a name="escaping-reserved-words"></a></p>

<h2 id="转义保留字">转义保留字</h2>

<p>PHQL 有几个保留字, 如果要将其中任何一个用作属性或模型名称, 则需要使用跨数据库转义分隔符 ` [<code> 和 </code>] ` 来转义这些单词:</p>

<pre><code class="language-php">&lt;?php

$phql   = 'SELECT * FROM [Update]';
$result = $manager-&gt;executeQuery($phql);

$phql   = 'SELECT id, [Like] FROM Posts';
$result = $manager-&gt;executeQuery($phql);
</code></pre>

<p>根据应用程序当前运行的数据库系统，将分隔符动态转换为有效的分隔符。</p>

<p><a name="lifecycle"></a></p>

<h2 id="phql生命周期">PHQL生命周期</h2>

<p>作为一种高级语言, PHQL 使开发人员能够个性化和自定义不同方面, 以满足他们的需求。 以下是执行的每个 PHQL 语句的生命周期:</p>

<ul>
  <li>对 PHQL 进行解析并转换为中间表示 (IR), 该表示独立于数据库系统实现的 sql</li>
  <li>IR 根据与模型关联的数据库系统转换为有效的 sql</li>
  <li>PHQL statements are parsed once and cached in memory. Further executions of the same statement result in a slightly faster execution</li>
</ul>

<p><a name="raw-sql"></a></p>

<h2 id="使用原始的sql">使用原始的SQL</h2>

<p>数据库系统可以提供 PHQL 不支持的特定 sql 扩展, 在这种情况下, 原始 sql 可能是合适的:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Resultset\Simple as Resultset;

class Robots extends Model
{
    public static function findByCreateInterval()
    {
        // A raw SQL statement
        $sql = 'SELECT * FROM robots WHERE id &gt; 0';

        // Base model
        $robot = new Robots();

        // Execute the query
        return new Resultset(
            null,
            $robot,
            $robot-&gt;getReadConnection()-&gt;query($sql)
        );
    }
}
</code></pre>

<p>如果原始SQL查询在您的应用程序中是常见的，一个通用的方法可以添加到您的模型:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Resultset\Simple as Resultset;

class Robots extends Model
{
    public static function findByRawSql($conditions, $params = null)
    {
        // A raw SQL statement
        $sql = 'SELECT * FROM robots WHERE $conditions';

        // Base model
        $robot = new Robots();

        // Execute the query
        return new Resultset(
            null,
            $robot,
            $robot-&gt;getReadConnection()-&gt;query($sql, $params)
        );
    }
}
</code></pre>

<p>以上<code>findByRawSql</code>可使用如下:</p>

<pre><code class="language-php">&lt;?php

$robots = Robots::findByRawSql(
    'id &gt; ?',
    [
        10
    ]
);
</code></pre>

<p><a name="troubleshooting"></a></p>

<h2 id="疑难解答">疑难解答</h2>

<p>使用PHQL时要记住的一些事情:</p>

<ul>
  <li>类是区分大小写的，如果一个类在创建时没有使用相同的名称定义，这可能会导致在具有区分大小写文件系统(如Linux) 的操作系统中出现意外行为。</li>
  <li>必须在连接中定义正确的字符集，才能成功绑定参数。</li>
  <li>别名类不会被完全带名称空间的类所替代，因为这只发生在PHP代码中，而不在字符串中。</li>
  <li>如果启用了列重命名，避免使用与要重命名的列同名的列别名，这可能会使查询解析器感到困惑。</li>
</ul>

                    </div>
                </div>
            </div>
        </div>
    </div>

<footer>
    <div class="container">
        <div class="footer-wrapper clearfix">

            <div class="footer-link-container">
                <a class="footer-link" href="/">
                    <img class="footer-logo-img" src="/assets/images/footer_logo.svg" alt="logo">
                </a>
                <a class="footer-link" href="https://phalcon.link/about" target="_blank">
                    About
                </a>
                <a class="footer-link" href="https://phalcon.link/sponsors" target="_blank">
                    Sponsors
                </a>
                <a class="footer-link" href="https://phalcon.link/fund" target="_blank">
                    Support Us
                </a>
                <a class="footer-link" href="https://phalcon.link/download" target="_blank">
                    Download
                </a>
                <a class="footer-link" href="https://license.phalconphp.com/" target="_blank">
                    License New BSD
                </a>
            </div>

            <div class="footer-copyright">
                <a href="https://odva.pro/" target="_blank" class="o2-link">
                    <span>Development by</span> <img src="/assets/images/logo-o2.svg" alt="logo o2">
                </a>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript" src="/assets/js/main.min.js?v1547319779866581049"></script>
<script type="text/javascript" src="/assets/js/highlight/highlight.pack.js?v1547319779866581049"></script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
</body>
</html>
