<!doctype html>
<!--[if IE 8]>
<html lang="ja-jp" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="ja-jp" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="ja-jp" class="no-js">
<!--<![endif]-->








    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script type="text/javascript" src="/assets/js/viewport-min-width.js?v1547319779866581049"></script>
        <meta name="description"
              content="Official Phalcon Documentation">
        <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework, php extension, next generation framework, docs, documentation">
        <meta name="author" href="/humans.txt">
        <meta name="generator" content="Phalcon Team - Jekyll - Netlify">

        <link href="https://phalcon-docs4.netlify.com/3.4/ja-jp/db-models.html" rel="canonical">
        <title>Phalcon Framework Documentation</title>

        <!-- Twitter -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@zephirlang">
        <meta name="twitter:creator" content="@zephirlang">
        <meta name="twitter:title" content="Phalcon Framework Documentation">
        <meta name="twitter:description" content="Official Phalcon Documentation">
        <meta name="twitter:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <!-- Facebook -->
        <meta property="og:url" content="https://phalcon-docs4.netlify.com">
        <meta property="og:title" content="Phalcon Framework Documentation">
        <meta property="og:description" content="Official Phalcon Documentation">
        <meta property="og:type" content="website">
        <meta property="og:image" content="https://assets.phalconphp.com/phalcon/logo.png">

        <meta name="msapplication-TileColor" content="#FFFFFF">
        <meta name="msapplication-square70x70logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-70x70.png">
        <meta name="msapplication-TileImage"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-144x144.png">
        <meta name="msapplication-square150x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-150x150.png">
        <meta name="msapplication-wide310x150logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x150.png">
        <meta name="msapplication-square310x310logo"
              content="https://assets.phalconphp.com/phalcon/icons/mstile-310x310.png">

        <link rel="apple-touch-icon"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon.png">

        <link rel="apple-touch-icon-precomposed"
              sizes="57x57"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="60x60"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-60x60.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="72x72"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="76x76"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-76x76.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="114x114"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-114x114.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="120x120"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-120x120.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="144x144"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-144x144.png">
        <link rel="apple-touch-icon-precomposed"
              sizes="152x152"
              href="https://assets.phalconphp.com/phalcon/icons/apple-touch-icon-152x152.png">

        <link rel="icon"
              type="image/png"
              sizes="16x16"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-16x16.png">
        <link rel="icon"
              type="image/png"
              sizes="32x32"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-32x32.png">
        <link rel="icon"
              type="image/png"
              sizes="96x96"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-96x96.png">
        <link rel="icon"
              type="image/png"
              sizes="128x128"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-128x128.png">
        <link rel="icon"
              type="image/png"
              sizes="196x196"
              href="https://assets.phalconphp.com/phalcon/icons/favicon-196x196.png">
        <link rel="shortcut icon"
              type="image/png"
              href="https://assets.phalconphp.com/phalcon/favicon.ico"/>

        <link rel="alternate"
              type="application/rss+xml"
              title=" - "
              href="https://phalcon-docs4.netlify.com/feed.xml">

        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"
              integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE="
              crossorigin="anonymous" />
        <link rel="stylesheet" href="/assets/css/monokai.css?v1547319779866581049" />
        <link rel="stylesheet" href="/assets/css/style.css?v1547319779866581049" />

        <script defer src="https://use.fontawesome.com/releases/v5.6.1/js/all.js"
                integrity="sha384-R5JkiUweZpJjELPWqttAYmYM1P3SNEJRM6ecTQF05pFFtxmCO+Y1CiUhvuDzgSVZ"
                crossorigin="anonymous"></script>
        
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90300500-6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90300500-6');
    </script>

    </head>


<body onclick="o2.allNavSlideUp()">
    <header class="header-image-doc">
        <div class="container">
            <div class="header-wrapper">
                <div class="clearfix">
                    <div class="row">
                        <div class="col-md-2 col-sm-3  col-xs-8">
                            <div class="header-image__logo-wrapper">
                                <a href="/3.4/ja-jp">
                                    <img class="logo-img" src="/assets/images/header_logo.svg" alt="logo">
                                </a>
                            </div>
                        </div>
                        <div class="col-md-10 col-sm-9 top-menu">

                            <div class="nav-icon" onclick="o2.showMobileMenu();">
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                                <div class="nav-line"></div>
                            </div>
                            <nav class="header-nav">
                                <ul>
                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                                 alt="">
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list" onclick="event.stopPropagation();">
                                            
                                                <a href="/3.4/en/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                         alt="English (US)">
                                                    English (US)
                                                </a>
                                            
                                                <a href="/3.4/cs-cz/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/cs.png"
                                                         alt="Czech">
                                                    Czech
                                                </a>
                                            
                                                <a href="/3.4/de-de/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/de.png"
                                                         alt="German">
                                                    German
                                                </a>
                                            
                                                <a href="/3.4/es-es/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/es-ES.png"
                                                         alt="Spanish">
                                                    Spanish
                                                </a>
                                            
                                                <a href="/3.4/fa-ir/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fa.png"
                                                         alt="Persian">
                                                    Persian
                                                </a>
                                            
                                                <a href="/3.4/fr-fr/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fr.png"
                                                         alt="French">
                                                    French
                                                </a>
                                            
                                                <a href="/3.4/id-id/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/id.png"
                                                         alt="Indonesian">
                                                    Indonesian
                                                </a>
                                            
                                                <a href="/3.4/it-it/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/it.png"
                                                         alt="Italian">
                                                    Italian
                                                </a>
                                            
                                                <a href="/3.4/ja-jp/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                                         alt="Japanese">
                                                    Japanese
                                                </a>
                                            
                                                <a href="/3.4/pl-pl/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/pl.png"
                                                         alt="Polish">
                                                    Polish
                                                </a>
                                            
                                                <a href="/3.4/ru-ru/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ru.png"
                                                         alt="Russian">
                                                    Russian
                                                </a>
                                            
                                                <a href="/3.4/tr-tr/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/tr.png"
                                                         alt="Turkish">
                                                    Turkish
                                                </a>
                                            
                                                <a href="/3.4/uk-ua/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/uk.png"
                                                         alt="Ukrainian">
                                                    Ukrainian
                                                </a>
                                            
                                                <a href="/3.4/zh-cn/db-models" class="custom-select__list-item">
                                                    <img class="lang-image"
                                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                                         alt="Chinese Simplified">
                                                    Chinese Simplified
                                                </a>
                                            
                                        </div>
                                    </li>

                                        <li class="nav-item" onclick="o2.toggleState(this, event);">
                                            <div class="nav-item__selected custom-select__version">
                                                Version 3.4
                                                <span class="caret"></span>
                                            </div>
                                            <div class="nav-item__list" onclick="event.stopPropagation();">
                                                
                                                <a href="/3.4/ja-jp/db-models" class="custom-select__list-item">
                                                    <span>3.4</span>
                                                </a>
                                                
                                                <a href="/3.3/ja-jp/db-models" class="custom-select__list-item">
                                                    <span>3.3</span>
                                                </a>
                                                
                                                <a href="/3.2/ja-jp/db-models" class="custom-select__list-item">
                                                    <span>3.2</span>
                                                </a>
                                                
                                                <a href="/3.1/ja-jp/db-models" class="custom-select__list-item">
                                                    <span>3.1</span>
                                                </a>
                                                
                                                <a href="/4.0/ja-jp/db-models" class="custom-select__list-item">
                                                    <span>4.0</span>
                                                </a>
                                                
                                            </div>
                                        </li>

                                    <li class="nav-item" onclick="o2.toggleState(this, event);">
                                        <div class="nav-item_selected">
                                            Community
                                            <span class="caret"></span>
                                        </div>
                                        <div class="nav-item__list">
                                            <a href="https://phalcon.link/forum" class="custom-select__list-item" target="_blank">
                                                Forum
                                            </a>
                                            <a href="https://phalcon.link/blog" class="custom-select__list-item" target="_blank">
                                                Blog
                                            </a>
                                            <a href="https://phalcon.link/resources" class="custom-select__list-item" target="_blank">
                                                Resources
                                            </a>
                                            <div class="nav-item__divider"></div>
                                            <a href="https://phalcon.link/f" class="custom-select__list-item" target="_blank">
                                                Facebook
                                            </a>
                                            <a href="https://phalcon.link/t" class="custom-select__list-item" target="_blank">
                                                Twitter
                                            </a>
                                            <a href="https://phalcon.link/gab" class="custom-select__list-item" target="_blank">
                                                Gab.ai
                                            </a>
                                        </div>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/about">
                                            About
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/sponsors">
                                            Sponsors
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/fund">
                                            Support Us
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="https://phalcon.link/download">
                                            Download
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                        <div class="header-nav-mobile">
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    <img class="lang-image"
                                         src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                         alt="">
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/en/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/en-US.png"
                                                 alt="English (US)">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/cs-cz/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/cs.png"
                                                 alt="Czech">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/de-de/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/de.png"
                                                 alt="German">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/es-es/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/es-ES.png"
                                                 alt="Spanish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/fa-ir/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fa.png"
                                                 alt="Persian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/fr-fr/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/fr.png"
                                                 alt="French">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/id-id/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/id.png"
                                                 alt="Indonesian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/it-it/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/it.png"
                                                 alt="Italian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/ja-jp/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ja.png"
                                                 alt="Japanese">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/pl-pl/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/pl.png"
                                                 alt="Polish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/ru-ru/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/ru.png"
                                                 alt="Russian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/tr-tr/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/tr.png"
                                                 alt="Turkish">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/uk-ua/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/uk.png"
                                                 alt="Ukrainian">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-sm-3 col-xs-6">
                                        <a href="/3.4/zh-cn/db-models">
                                            <img class="lang-image"
                                                 src="https://d2srrzh48sp2nh.cloudfront.net/31cd209e/images/flags/zh-CN.png"
                                                 alt="Chinese Simplified">
                                            <span></span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this,event)">
                                    Version 3.4
                                    <span class="caret"></span>
                                </div>

                                <ul style="display:none;" class="clearfix" onclick="event.stopPropagation();">
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.4/ja-jp/db-models">
                                            <span>3.4</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.3/ja-jp/db-models">
                                            <span>3.3</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.2/ja-jp/db-models">
                                            <span>3.2</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/3.1/ja-jp/db-models">
                                            <span>3.1</span>
                                        </a>
                                    </li>
                                    
                                    <li class="nav-item nav-item-li col-xs-12">
                                        <a href="/4.0/ja-jp/db-models">
                                            <span>4.0</span>
                                        </a>
                                    </li>
                                    
                                </ul>

                            </div>
                            <div>
                                <div class="nav-item nav-item-accordion" onclick="o2.topicsAccordion(this, event)">
                                    
                                    <span class="caret"></span>
                                </div>
                                <ul style="display:none;">
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/forum" target="_blank">
                                            Forum
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/blog" target="_blank">
                                            Blog
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/resources" target="_blank">
                                            Resources
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/f" target="_blank">
                                            Facebook
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/t" target="_blank">
                                            Twitter
                                        </a>
                                    </li>
                                    <li class="nav-item nav-item-li">
                                        <a href="https://phalcon.link/gab" target="_blank">
                                            Gab.ai
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/about">
                                    About
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/sponsors">
                                    Sponsors
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/fund">
                                    Support Us
                                </a>
                            </div>
                            <div class="nav-item">
                                <a href="https://phalcon.link/download">
                                    Download
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <div class="container-fluid article-page-wrap">
        <div class="row">
            <div>
                <div class="col-md-2 sidebar hidden-xs">
                    <div class="sidebar--spacer">&nbsp;</div>
                </div>
                <div class="m-t-md m-b-lg" id="articles">
                    <div class="article-content">
                        <p><a name="working-with"></a></p>

<h1 id="モデルの動作">モデルの動作</h1>

<p>モデルは、アプリケーションの情報 (データ) と、そのデータを操作するためのルールを表します。 モデルは主に、それに対応するテーブルとの対話のルールを管理するために使用されます。 ほとんどの場合、データベース内の各テーブルは、アプリケーション内の1つのモデルと対応します。 アプリケーションのビジネスロジックの大半は、モデルに集中します。</p>

<p><a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> is the base for all models in a Phalcon application. データベースの独立性、基本的なCRUD機能、高度な検索機能、および他のサービスの中でモデルを相互に関連付ける機能を提供します。 <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> avoids the need of having to use SQL statements because it translates methods dynamically to the respective database engine operations.</p>

<h5 class="alert alert-warning">モデルは、高い抽象化レイヤーでデータベースと連動します。 If you need to work with databases at a lower level check out the <a href="api/Phalcon_Db">Phalcon\Db</a> component documentation.</h5>

<p><a name="creating"></a></p>

<h2 id="モデルの作成">モデルの作成</h2>

<p>A model is a class that extends from <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a>. Its class name should be in camel case notation:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class RobotParts extends Model
{

}
</code></pre>

<h5 class="alert alert-warning">PHP 5.4/5.5を使用している場合は、メモリを節約しメモリの割り当てを削減するために、一部のモデルは各列を宣言することをお勧めします。 </h5>

<p>デフォルトでは、モデル <code>Store\Toys\RobotParts</code> が <code>robot_parts</code> テーブルにマッピングされます。 マッピングされたテーブル名を手動で指定する場合は、 <code>setSource()</code> メソッドが使用できます:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class RobotParts extends Model
{
    public function initialize()
    {
        $this-&gt;setSource('toys_robot_parts');
    }
}
</code></pre>

<p>The model <code>RobotParts</code> now maps to <code>toys_robot_parts</code> table. The <code>initialize()</code> method helps with setting up this model with a custom behavior i.e. a different table.</p>

<p><code>initialize()</code> メソッドはリクエスト時に1度だけ呼ばれます。 このメソッドは、アプリケーション内で作成されたモデルのすべてのインスタンスに適用される、初期化処理を実行するためのものです。 作成されたすべてのインスタンスに対して初期化タスクを実行する場合は、<code>onConstruct()</code> メソッドを使用できます。</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class RobotParts extends Model
{
    public function onConstruct()
    {
        // ...
    }
}
</code></pre>

<p><a name="properties-setters-getters"></a></p>

<h3 id="パブリックプロバティー-vs-セッターゲッター">パブリックプロバティー VS セッター/ゲッター</h3>

<p>モデルはパブリックプロパティとして実装できます。つまり、モデルクラスをインスタンス化したコードの任意の部分から各プロパティを読み込み/更新できます。</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public $id;

    public $name;

    public $price;
}
</code></pre>

<p>もう1つの実装では、gettersとsetter関数を使用して、そのモデルで公開されているプロパティを制御します。 getterとsetterを使用する利点は、パブリックプロパティを使用する場合に不可能な、モデルに対して設定された値の変換と検証チェックを実行できることです。 さらに、getterとsetterは、モデルクラスのインタフェースを変更せずに将来の変更を可能にします。 したがって、フィールド名が変更された場合に必要な変更は、関連するgetter/setterで参照されているモデルのプライベートプロパティだけで、コード内の他の場所にはありません。</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use InvalidArgumentException;
use Phalcon\Mvc\Model;

class Robots extends Model
{
    protected $id;

    protected $name;

    protected $price;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function setName($name)
    {
        // 名前は短すぎないか？
        if (strlen($name) &lt; 10) {
            throw new InvalidArgumentException(
                'The name is too short'
            );
        }

        $this-&gt;name = $name;
    }

    public function getName()
    {
        return $this-&gt;name;
    }

    public function setPrice($price)
    {
        // マイナスの価格は許可されない
        if ($price &lt; 0) {
            throw new InvalidArgumentException(
                "Price can't be negative"
            );
        }

        $this-&gt;price = $price;
    }

    public function getPrice()
    {
        // 使う前にdouble型に変換
        return (double) $this-&gt;price;
    }
}
</code></pre>

<p>パブリックプロパティは、開発の複雑さを軽減します。 しかし、getter/setterはアプリケーションのテスト容易性、拡張性、保守性を大幅に向上させる可能性があります。 開発者はアプリケーションのニーズに応じて、作成するアプリケーションに適した戦略を決めることができます。 ORMは、プロパティを定義する両方のスキーマと互換性があります。</p>

<h5 class="alert alert-warning">getterとsetterを使用すると、プロパティ名のアンダースコアが問題になることがあります。 </h5>

<p>プロパティ名にアンダースコアを使用する場合は、マジックメソッドで使用するために、getter/setter宣言でキャメルケースを使う必要があります。 (例えば、 <code>$model-&gt;getProperty_name</code> は <code>$model-&gt;getPropertyName</code> に, <code>$model-&gt;findByProperty_name</code> は <code>$model-&gt;findByPropertyName</code> にするなど) 多くのシステムではキャメルケースが前提とされ、アンダースコアは一般的に削除されるためドキュメント全体に示されている方法でプロパティの名前を付けることをお勧めします。 カラムのマッピングを使用すると（上で説明したように）、データベースに対してプロパティを正しくマッピングすることができます。</p>

<p><a name="records-to-objects"></a></p>

<h2 id="オブジェクトへのレコード格納について理解する">オブジェクトへのレコード格納について理解する</h2>

<p>Every instance of a model represents a row in the table. You can easily access record data by reading object properties. For example, for a table ‘robots’ with the records:</p>

<pre><code class="language-sql">mysql&gt; select * from robots;
+----+------------+------------+------+
| id | name       | type       | year |
+----+------------+------------+------+
|  1 | Robotina   | mechanical | 1972 |
|  2 | Astro Boy  | mechanical | 1952 |
|  3 | Terminator | cyborg     | 2029 |
+----+------------+------------+------+
3 rows in set (0.00 sec)
</code></pre>

<p>プライマリキーで特定のレコードを見つけ、その名前を出力することができます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// id = 3のレコードを検索
$robot = Robots::findFirst(3);

// 'Terminator' を出力
echo $robot-&gt;name;
</code></pre>

<p>一度レコードがメモリ内に格納されれば、データを更新して、その変更を保存することができます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = Robots::findFirst(3);

$robot-&gt;name = 'RoboCop';

$robot-&gt;save();
</code></pre>

<p>As you can see, there is no need to use raw SQL statements. <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> provides high database abstraction for web applications.</p>

<p><a name="finding-records"></a></p>

<h2 id="レコードの検索">レコードの検索</h2>

<p><a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> also offers several methods for querying records. The following examples will show you how to query one or more records from a model:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// どれくらいロボットがいるか？
$robots = Robots::find();
echo 'There are ', count($robots), "\n";

// 機械式のロボットはどれくらいいるか？
$robots = Robots::find("type = 'mechanical'");
echo 'There are ', count($robots), "\n";

// バーチャルなロボットを取得して名前順に並び替えて出力する
$robots = Robots::find(
    [
        "type = 'virtual'",
        'order' =&gt; 'name',
    ]
);
foreach ($robots as $robot) {
    echo $robot-&gt;name, "\n";
}

// バーチャルなロボットを名前順に並び替えて最初の100件を取得する
$robots = Robots::find(
    [
        "type = 'virtual'",
        'order' =&gt; 'name',
        'limit' =&gt; 100,
    ]
);
foreach ($robots as $robot) {
   echo $robot-&gt;name, "\n";
}
</code></pre>

<h5 class="alert alert-warning">外部データ（ユーザー入力など）や変数データでレコードを検索する場合は、 <a href="#binding-parameters">バインディングパラメータ</a> を使用する必要があります。</h5>

<p><code>findFirst()</code> メソッドを使用して、指定した条件に一致する最初のレコードのみを取得することもできます。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// robotsテーブルの最初のレコードは？
$robot = Robots::findFirst();
echo 'The robot name is ', $robot-&gt;name, "\n";

// robotsテーブルの最初の機械式のロボットは？
$robot = Robots::findFirst("type = 'mechanical'");
echo 'The first mechanical robot name is ', $robot-&gt;name, "\n";

// バーチャルなロボットを名前順に並び替えて最初の100件を取得する
$robot = Robots::findFirst(
    [
        "type = 'virtual'",
        'order' =&gt; 'name',
    ]
);

echo 'The first virtual robot name is ', $robot-&gt;name, "\n";
</code></pre>

<p><code>find()</code> および <code>findFirst()</code> メソッドは、検索条件を指定する連想配列を受け付けます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = Robots::findFirst(
    [
        "type = 'virtual'",
        'order' =&gt; 'name DESC',
        'limit' =&gt; 30,
    ]
);

$robots = Robots::find(
    [
        'conditions' =&gt; 'type = ?1',
        'bind'       =&gt; [
            1 =&gt; 'virtual',
        ]
    ]
);
</code></pre>

<p>使用可能なクエリのオプションは次のとおりです:</p>

<table>
  <thead>
    <tr>
      <th>パラメーター</th>
      <th>説明</th>
      <th>例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>conditions</code></td>
      <td>find時の検索条件。 指定された条件を満たすレコードのみを抽出するために使用されます。 By default <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> assumes the first parameter are the conditions.</td>
      <td><code>'conditions' =&gt; "name LIKE 'steve%'"</code></td>
    </tr>
    <tr>
      <td><code>columns</code></td>
      <td>モデル内の完全な列の代わりに特定の列を返します。 When using this option an incomplete object is returned</td>
      <td><code>'columns' =&gt; 'id, name'</code></td>
    </tr>
    <tr>
      <td><code>bind</code></td>
      <td>bindは、プレースホルダをエスケープ値で置き換えるオプションと一緒に使用されるため、セキュリティが強化されます。</td>
      <td><code>'bind' =&gt; ['status' =&gt; 'A', 'type' =&gt; 'some-time']</code></td>
    </tr>
    <tr>
      <td><code>bindTypes</code></td>
      <td>パラメータをバインドする時にこのパラメータを使用すると、バインドされたパラメータをさらに型キャストして、セキュリティをさらに強化することができます。</td>
      <td><code>'bindTypes' =&gt; [Column::BIND_PARAM_STR, Column::BIND_PARAM_INT]</code></td>
    </tr>
    <tr>
      <td><code>order</code></td>
      <td>結果セットをソートするために使用されます。 1つまたは複数のフィールドをカンマで区切って使用します。</td>
      <td><code>'order' =&gt; 'name DESC, status'</code></td>
    </tr>
    <tr>
      <td><code>limit</code></td>
      <td>クエリの結果を特定の範囲に制限します。</td>
      <td><code>'limit' =&gt; 10</code></td>
    </tr>
    <tr>
      <td><code>offset</code></td>
      <td>クエリの結果を一定量だけオフセットします。</td>
      <td><code>'offset' =&gt; 5</code></td>
    </tr>
    <tr>
      <td><code>group</code></td>
      <td>複数のレコードにわたってデータを収集し、結果を1つ以上の列でグループ化することができます。</td>
      <td><code>'group' =&gt; 'name, status'</code></td>
    </tr>
    <tr>
      <td><code>for_update</code></td>
      <td>With this option, <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> reads the latest available data, setting exclusive locks on each row it reads</td>
      <td><code>'for_update' =&gt; true</code></td>
    </tr>
    <tr>
      <td><code>shared_lock</code></td>
      <td>With this option, <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> reads the latest available data, setting shared locks on each row it reads</td>
      <td><code>'shared_lock' =&gt; true</code></td>
    </tr>
    <tr>
      <td><code>cache</code></td>
      <td>結果セットをキャッシュし、リレーショナルシステムへの継続的なアクセスを減らします。</td>
      <td><code>'cache' =&gt; ['lifetime' =&gt; 3600, 'key' =&gt; 'my-find-key']</code></td>
    </tr>
    <tr>
      <td><code>hydration</code></td>
      <td>結果に返された各レコードを表すためのハイドレーション戦略を設定します。</td>
      <td><code>'hydration' =&gt; Resultset::HYDRATE_OBJECTS</code></td>
    </tr>
  </tbody>
</table>

<p>必要に応じて、一連のパラメータを使用する代わりに、オブジェクト指向の方法でクエリを作成する方法もあります:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robots = Robots::query()
    -&gt;where('type = :type:')
    -&gt;andWhere('year &lt; 2000')
    -&gt;bind(['type' =&gt; 'mechanical'])
    -&gt;order('name')
    -&gt;execute();
</code></pre>

<p>The static method <code>query()</code> returns a <a href="api/Phalcon_Mvc_Model_Criteria">Phalcon\Mvc\Model\Criteria</a> object that is friendly with IDE autocompleters.</p>

<p>All the queries are internally handled as <a href="/3.4/en/db-phql">PHQL</a> queries. PHQLは、高度で、オブジェクト指向な、SQLライクな言語です。 この言語は、他のモデルへのjoin、グルーピングの定義、集計の追加など、クエリを実行するための多くの機能を提供します。</p>

<p>最後に、 <code>findFirstBy&lt;property-name&gt;()</code> メソッドがあります。 このメソッドは、前述の <code>findFirst()</code> メソッドを拡張します。 メソッド自体のプロパティ名を使用し、その列で検索するデータを含むパラメータを渡すことで、テーブルからの取得を素早く実行できます。 例が整っているので前述のRomotsモデルを使用します:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public $id;

    public $name;

    public $price;
}
</code></pre>

<p>ここでは3つのプロパティがあります: <code>$id</code>, <code>$name</code>, <code>$price</code> それでは、テーブル内で名前が ‘Terminator’ の最初のレコードを取得したいとしましょう。 このように記述することができます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$name = 'Terminator';

$robot = Robots::findFirstByName($name);

if ($robot) {
    echo 'The first robot with the name ' . $name . ' cost ' . $robot-&gt;price . '.';
} else {
    echo 'There were no robots found in our table with the name ' . $name . '.';
}
</code></pre>

<p>メソッド呼び出しで ‘Name’ を使用し、 <code>$name</code> という変数を渡したことに注目してください。この変数には、テーブルで検索する名前が含まれています。 また、クエリと一致するものが見つかると、他のすべてのプロパティも同様に使用できることに注意してください。</p>

<p><a name="resultsets"></a></p>

<h3 id="モデルの結果セット">モデルの結果セット</h3>

<p>While <code>findFirst()</code> returns directly an instance of the called class (when there is data to be returned), the <code>find()</code> method returns a <a href="api/Phalcon_Mvc_Model_Resultset_Simple">Phalcon\Mvc\Model\Resultset\Simple</a>. これは結果セットを横断したり、特定のレコードを探したり数えたりするような、すべての機能をカプセル化するオブジェクトです。</p>

<p>これらのオブジェクトは、スタンダードな配列よりも強力です。 One of the greatest features of the <a href="api/Phalcon_Mvc_Model_Resultset">Phalcon\Mvc\Model\Resultset</a> is that at any time there is only one record in memory. これは特に、大量のデータを扱う場合のメモリ管理に大きく役立ちます。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// 全てのロボットを取得
$robots = Robots::find();

// foreachで横断する
foreach ($robots as $robot) {
    echo $robot-&gt;name, "\n";
}

// whileで横断する
$robots-&gt;rewind();

while ($robots-&gt;valid()) {
    $robot = $robots-&gt;current();

    echo $robot-&gt;name, "\n";

    $robots-&gt;next();
}

// 結果セットをカウント
echo count($robots);

// 結果セットをカウントする他の方法
echo $robots-&gt;count();

// 内部カーソルを3番目のロボットに移動する
$robots-&gt;seek(2);

$robot = $robots-&gt;current();

// 結果セットのあるポジションのロボットにアクセス
$robot = $robots[5];

// 特定の位置にレコードがあるかどうかを確認する
if (isset($robots[3])) {
   $robot = $robots[3];
}

// 結果セットの最初のレコードを取得
$robot = $robots-&gt;getFirst();

// 最後のレコードを取得
$robot = $robots-&gt;getLast();
</code></pre>

<p>Phalconの結果セットはスクロール可能なカーソルをエミュレートします。その位置にアクセスするだけで行を取得したり、特定のポジションへの内部ポインタを探すことができます。 一部のデータベースシステムではスクロール可能なカーソルはサポートされていません。このため、要求されたポジションのレコードを取得するために、カーソルを先頭に戻してクエリを再実行する必要があります。 同様に、結果セットが複数回走査される場合、クエリは同じ回数だけ実行されなければなりません。</p>

<p>大きなクエリ結果をメモリに格納すると、多くのリソースを消費する可能性があります。結果セットは32行のチャンクでデータベースから取得されるため、いくつかのケースではリクエストを再実行する必要性が減ります。</p>

<p>結果セットをシリアライズしてキャッシュバックエンドに格納できることに注意してください。 <a href="api/Phalcon_Cache">Phalcon\Cache</a> can help with that task. However, serializing data causes <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> to retrieve all the data from the database in an array, thus consuming more memory while this process takes place.</p>

<pre><code class="language-php">&lt;?php

// partsモデルからすべてのレコードを照会します
$parts = Parts::find();

// ファイルに結果セットを保存
file_put_contents(
    'cache.txt',
    serialize($parts)
);

// ファイルからpartsを取得
$parts = unserialize(
    file_get_contents('cache.txt')
);

// partsを走査
foreach ($parts as $part) {
    echo $part-&gt;id;
}
</code></pre>

<p><a name="custom-resultsets"></a></p>

<h3 id="カスタム結果セット">カスタム結果セット</h3>

<p>アプリケーションのロジックでは、データベースから取得されたデータに対して、追加の操作を必要とすることがあります。 以前は、モデルを拡張して、モデルのクラスやtraitの機能をカプセル化し、通常は変換されたデータの配列を呼び出し側に返すだけでした。</p>

<p>カスタム結果セットでは、これを行う必要はありません。 カスタム結果セットは、他のモデルになる機能をカプセル化し、他のモデルから再利用することができます。このためコードの <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> が保たれます。 This way, the <code>find()</code> method will no longer return the default <a href="api/Phalcon_Mvc_Model_Resultset">Phalcon\Mvc\Model\Resultset</a>, but instead the custom one. Phalconでは、モデル内で <code>getResultsetClass()</code> を使用してこれを行うことができます。</p>

<p>最初に、結果セットのクラスを定義する必要があります:</p>

<pre><code class="language-php">&lt;?php

namespace Application\Mvc\Model\Resultset;

use \Phalcon\Mvc\Model\Resultset\Simple;

class Custom extends Simple
{
    public function getSomeData() {
        /** CODE */
    }
}
</code></pre>

<p>モデルでは、クラスを次のように <code>getResultsetClass()</code> に設定します。</p>

<pre><code class="language-php">&lt;?php

namespace Phalcon\Test\Models\Statistics;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function getSource()
    {
        return 'robots';
    }

    public function getResultsetClass()
    {
    return 'Application\Mvc\Model\Resultset\Custom';
    }
}
</code></pre>

<p>そして最後にあなたのコードでは、次のようなになります:</p>

<pre><code class="language-php">&lt;?php

/**
 * robotsの検索
 */
$robots = Robots::find(
    [
        'conditions' =&gt; 'date between "2017-01-01" AND "2017-12-31"',
        'order'      =&gt; 'date'
    ]
);

/**
 * データをビューに渡す
 */
$this-&gt;view-&gt;mydata = $robots-&gt;getSomeData();
</code></pre>

<p><a name="filters"></a></p>

<h3 id="結果セットのフィルタリング">結果セットのフィルタリング</h3>

<p>データをフィルタリングする最も効率的な方法は、いくつかの検索条件を設定することです。データベースは、テーブルに設定されたインデックスを使用してデータを高速に返します。 Phalconではさらに、データベースでは利用できない機能を、PHPを使うことでデータをフィルタリングすることができます:</p>

<pre><code class="language-php">&lt;?php

$customers = Customers::find();

$customers = $customers-&gt;filter(
    function ($customer) {
        // 有効な電子メールを持っている顧客のみを返します
        if (filter_var($customer-&gt;email, FILTER_VALIDATE_EMAIL)) {
            return $customer;
        }
    }
);
</code></pre>

<p><a name="binding-parameters"></a></p>

<h3 id="パラメーターのバインド">パラメーターのバインド</h3>

<p>Bound parameters are also supported in <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a>. この方法論を使用して、コードがSQLインジェクション攻撃を受けないようにすることをお勧めします。 文字列と整数の両方のプレースホルダがサポートされています。 パラメータのバインドは、以下のように簡単に実施できます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// 文字列プレースホルダを使用してパラメータをバインドするrobotsテーブル用クエリ
// プレースホルダと同じキーのパラメータ
$robots = Robots::find(
    [
        'name = :name: AND type = :type:',
        'bind' =&gt; [
            'name' =&gt; 'Robotina',
            'type' =&gt; 'maid',
        ],
    ]
);

// 整数のプレースホルダによるパラメータをバインドしたrobotsテーブル用クエリ
$robots = Robots::find(
    [
        'name = ?1 AND type = ?2',
        'bind' =&gt; [
            1 =&gt; 'Robotina',
            2 =&gt; 'maid',
        ],
    ]
);

// 文字列と整数の両方のプレースホルダによるパラメータをバインドしたrobotsテーブル用クエリ
// プレースホルダと同じキーのパラメータ
$robots = Robots::find(
    [
        'name = :name: AND type = ?1',
        'bind' =&gt; [
            'name' =&gt; 'Robotina',
            1      =&gt; 'maid',
        ],
    ]
);
</code></pre>

<p>数値プレースホルダを使用する場合は、整数を <code>1</code> または <code>2</code> として定義する必要があります。 この場合、 <code>'1'</code> または <code>'2'</code> は文字列であり数字ではないため、プレースホルダを正常に置き換えることができません。</p>

<p>文字列は <a href="http://php.net/manual/en/pdo.prepared-statements.php">PDO</a> を使用して自動的にエスケープされます。 この関数は接続文字セットを考慮しているため、接続パラメータまたはデータベースの設定で、正しい文字セットを定義することをお勧めします。データセットを格納または取得するときに間違った文字セットが望ましくない影響を及ぼすためです。</p>

<p>さらに、パラメータ <code>bindTypes</code> を設定することができます。これにより、データ型に応じてパラメータをバインドする方法を定義できます:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Db\Column;
use Store\Toys\Robots;

// バインドパラメータ
$parameters = [
    'name' =&gt; 'Robotina',
    'year' =&gt; 2008,
];

// 型キャスト
$types = [
    'name' =&gt; Column::BIND_PARAM_STR,
    'year' =&gt; Column::BIND_PARAM_INT,
];

// 文字列プレースホルダを使用してパラメータをバインドするrobotsテーブル用クエリ
$robots = Robots::find(
    [
        'name = :name: AND year = :year:',
        'bind'      =&gt; $parameters,
        'bindTypes' =&gt; $types,
    ]
);
</code></pre>

<h5 class="alert alert-warning">デフォルトのバインドタイプは <code>Phalcon\Db\Column::BIND_PARAM_STR</code> なので、すべてのカラムがそのタイプの場合は 'bindTypes' パラメータを指定する必要はありません。</h5>

<p>バインドパラメータに配列をバインドする場合、キーには0から番号を付ける必要があることに注意してください:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$array = ['a','b','c']; // $array: [[0] =&gt; 'a', [1] =&gt; 'b', [2] =&gt; 'c']

unset($array[1]); // $array: [[0] =&gt; 'a', [2] =&gt; 'c']

// キーの番号を振り直さなければならない
$array = array_values($array); // $array: [[0] =&gt; 'a', [1] =&gt; 'c']

$robots = Robots::find(
    [
        'letter IN ({letter:array})',
        'bind' =&gt; [
            'letter' =&gt; $array
        ]
    ]
);
</code></pre>

<h5 class="alert alert-warning">バインドされたパラメータは、 <code>find()</code> や <code>findFirst()</code> などのすべてのクエリメソッドで使用でき、 <code>count()</code> 、 <code>sum()</code> 、 <code>average()</code> などの集計関数も同様です。 </h5>

<p>もし “finders” ( <code>find()</code>、 <code>findFirst()</code> 、etc) を使用している場合、バインドパラメータは自動的に使用されます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

// バインドパラメータを使用する明示的なクエリ
$robots = Robots::find(
    [
        'name = ?0',
        'bind' =&gt; [
            'Ultron',
        ],
    ]
);

// バインドパラメータを使用した暗黙的なクエリ
$robots = Robots::findByName('Ultron');
</code></pre>

<p><a name="preparing-records"></a></p>

<h2 id="取得したレコードの初期化準備">取得したレコードの初期化/準備</h2>

<p>データベースからレコードを取得した後に、アプリケーションの残りの部分が使用する前にデータを初期化する必要があるかもしれません。 モデル内で <code>afterFetch()</code> メソッドを実装することができます。このイベントは、インスタンスを作成してデータを割り当てる直後に実行されます。</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public $id;

    public $name;

    public $status;

    public function beforeSave()
    {
        // 配列を文字列に変換
        $this-&gt;status = join(',', $this-&gt;status);
    }

    public function afterFetch()
    {
        // 文字列を配列に変換
        $this-&gt;status = explode(',', $this-&gt;status);
    }

    public function afterSave()
    {
        // 文字列を配列に変換
        $this-&gt;status = explode(',', $this-&gt;status);
    }
}
</code></pre>

<p>publicプロパティの代わり、もしくは一緒にgetters/settersを使用する場合、一度アクセスされたフィールドを初期化することができます:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public $id;

    public $name;

    public $status;

    public function getStatus()
    {
        return explode(',', $this-&gt;status);
    }
}
</code></pre>

<p><a name="calculations"></a></p>

<h2 id="集計の生成">集計の生成</h2>

<p>計算（集計）は、データベースシステムで一般に使用される、<code>COUNT</code> 、 <code>SUM</code> 、 <code>MAX</code> 、 <code>MIN</code> 、 <code>AVG</code> などの関数のヘルパーです。 <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> allows to use these functions directly from the exposed methods.</p>

<p>countの例:</p>

<pre><code class="language-php">&lt;?php

// 従業員は何名？
$rowcount = Employees::count();

// 従業員に割り当てられる担当はいくつあるか？
$rowcount = Employees::count(
    [
        'distinct' =&gt; 'area',
    ]
);

// 検査担当の従業員は何名いるか？
$rowcount = Employees::count(
    'area = 'Testing''
);

// 担当別にグルーピングした結果で従業員をカウントする
$group = Employees::count(
    [
        'group' =&gt; 'area',
    ]
);
foreach ($group as $row) {
   echo 'There are ', $row-&gt;rowcount, ' in ', $row-&gt;area;
}

// 従業員を担当別にグルーピングしてカウントし、件数で結果を並び替える
$group = Employees::count(
    [
        'group' =&gt; 'area',
        'order' =&gt; 'rowcount',
    ]
);

// バインドされたパラメータを使用してSQLインジェクションを避ける
$group = Employees::count(
    [
        'type &gt; ?0',
        'bind' =&gt; [
            $type
        ],
    ]
);
</code></pre>

<p>sumの例:</p>

<pre><code class="language-php">&lt;?php

// 全従業員の給与はいくらか？
$total = Employees::sum(
    [
        'column' =&gt; 'salary',
    ]
);

// 全ての営業担当の給与はいくらか？
$total = Employees::sum(
    [
        'column'     =&gt; 'salary',
        'conditions' =&gt; "area = 'Sales'",
    ]
);

// 各担当ごとの給与のグルーピングを生成する
$group = Employees::sum(
    [
        'column' =&gt; 'salary',
        'group'  =&gt; 'area',
    ]
);
foreach ($group as $row) {
   echo 'The sum of salaries of the ', $row-&gt;area, ' is ', $row-&gt;sumatory;
}

// 各担当ごとの給与のグルーピングを生成して
// 給与が高いものから低いものへ並べる
$group = Employees::sum(
    [
        'column' =&gt; 'salary',
        'group'  =&gt; 'area',
        'order'  =&gt; 'sumatory DESC',
    ]
);

// バインドされたパラメータを使用してSQLインジェクションを避ける
$group = Employees::sum(
    [
        'conditions' =&gt; 'area &gt; ?0',
        'bind'       =&gt; [
            $area
        ],
    ]
);
</code></pre>

<p>averageの例:</p>

<pre><code class="language-php">&lt;?php

// 全従業員の平均給与はいくらか？
$average = Employees::average(
    [
        'column' =&gt; 'salary',
    ]
);

// 営業担当者の平均給与はいくらか？
$average = Employees::average(
    [
        'column'     =&gt; 'salary',
        'conditions' =&gt; "area = 'Sales'",
    ]
);

// バインドされたパラメータを使用してSQLインジェクションを避ける
$average = Employees::average(
    [
        'column'     =&gt; 'age',
        'conditions' =&gt; 'area &gt; ?0',
        'bind'       =&gt; [
            $area
        ],
    ]
);
</code></pre>

<p>max/min の例:</p>

<pre><code class="language-php">&lt;?php

// 全従業員で最年長は？
$age = Employees::maximum(
    [
        'column' =&gt; 'age',
    ]
);

// 全ての営業担当で最年長は？
$age = Employees::maximum(
    [
        'column'     =&gt; 'age',
        'conditions' =&gt; "area = 'Sales'",
    ]
);

// 全従業員中の最低給与は？
$salary = Employees::minimum(
    [
        'column' =&gt; 'salary',
    ]
);
</code></pre>

<p><a name="create-update-records"></a></p>

<h2 id="レコードの登録と更新">レコードの登録と更新</h2>

<p><code>Phalcon\Mvc\Model::save()</code> メソッドを使用すると、モデルに関連付けられたテーブルにレコードがすでに存在するかどうかによってレコードを作成/更新できます。 The save method is called internally by the create and update methods of <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a>. これが期待どおりに機能するためには、レコードを更新または作成するかどうかを判断するために、主キーをエンティティに適切に定義する必要があります。</p>

<p>またこのメソッドはモデルで定義されている関連付けられたバリデータ、仮想外部キー、およびイベントを実行します。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;type = 'mechanical';
$robot-&gt;name = 'Astro Boy';
$robot-&gt;year = 1952;

if ($robot-&gt;save() === false) {
    echo "Umh, We can't store robots right now: \n";

    $messages = $robot-&gt;getMessages();

    foreach ($messages as $message) {
        echo $message, "\n";
    }
} else {
    echo 'Great, a new robot was saved successfully!';
}
</code></pre>

<p>すべての列を手動で割り当てるのを避けるために、配列を <code>save</code> に渡すことができます。 <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> will check if there are setters implemented for the columns passed in the array giving priority to them instead of assign directly the values of the attributes:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;save(
    [
        'type' =&gt; 'mechanical',
        'name' =&gt; 'Astro Boy',
        'year' =&gt; 1952,
    ]
);
</code></pre>

<p>直接または属性の配列を介して割り当てられた値は、関連する属性データ型に従ってエスケープ/サニタイズされます。 SQLインジェクションを心配することなく、安全でない配列を渡すことができます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;save($_POST);
</code></pre>

<h5 class="alert alert-warning">脆弱性対策に注意を払わないと、攻撃者はデータベースの列の値を設定できてしまいます。 これらのフィールドが送信されたフォームにない場合でも、モデルのすべての列を挿入/更新できるようにする場合にのみ、この機能を使用します。 </h5>

<p><code>save</code> に追加のパラメータを設定して、脆弱性対策を行う際に考慮する必要があるフィールドの、ホワイトリストを設定することができます。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;save(
    $_POST,
    [
        'name',
        'type',
    ]
);
</code></pre>

<p><a name="create-update-with-confidence"></a></p>

<h3 id="確実に作成更新する">確実に作成／更新する</h3>

<p>アプリケーションの負荷が高い時には、レコードが作成されることを期待しているにも関わらず、更新されてしまう場合があります。 これは、 <code>Phalcon\Mvc\Model::save()</code> を使用してデータベースのレコードに永続化する際に発生します。 レコードの作成や更新を確実に行いたい場合は、<code>save()</code> の代わりに <code>create()</code> や <code>update()</code> の呼び出しに変更できます。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;type = 'mechanical';
$robot-&gt;name = 'Astro Boy';
$robot-&gt;year = 1952;

// このレコードは作成されなければいけない
if ($robot-&gt;create() === false) {
    echo "Umh, We can't store robots right now: \n";

    $messages = $robot-&gt;getMessages();

    foreach ($messages as $message) {
        echo $message, "\n";
    }
} else {
    echo 'Great, a new robot was created successfully!';
}
</code></pre>

<p><code>create</code> と <code>update</code> メソッドは、値の配列をパラメータとして受け入れます。</p>

<p><a name="delete-records"></a></p>

<h2 id="レコードの削除">レコードの削除</h2>

<p>The <code>Phalcon\Mvc\Model::delete()</code> method allows to delete a record. You can use it as follows:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robot = Robots::findFirst(11);

if ($robot !== false) {
    if ($robot-&gt;delete() === false) {
        echo "Sorry, we can't delete the robot right now: \n";

        $messages = $robot-&gt;getMessages();

        foreach ($messages as $message) {
            echo $message, "\n";
        }
    } else {
        echo 'The robot was deleted successfully!';
    }
}
</code></pre>

<p><code>foreach</code> を使用して結果セットを横断することで、多くのレコードを削除することもできます。</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robots = Robots::find(
    "type = 'mechanical'"
);

foreach ($robots as $robot) {
    if ($robot-&gt;delete() === false) {
        echo "Sorry, we can't delete the robot right now: \n";

        $messages = $robot-&gt;getMessages();

        foreach ($messages as $message) {
            echo $message, "\n";
        }
    } else {
        echo 'The robot was deleted successfully!';
    }
}
</code></pre>

<p>削除が処理される際に、カスタムビジネスルールの実行を定義するには、次のイベントを使用します。</p>

<table>
  <thead>
    <tr>
      <th>操作</th>
      <th>名前</th>
      <th style="text-align: center">処理中断が可能</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>削除</td>
      <td>afterDelete</td>
      <td style="text-align: center">いいえ</td>
      <td>削除処理が行われた後に実行されます。</td>
    </tr>
    <tr>
      <td>削除</td>
      <td>beforeDelete</td>
      <td style="text-align: center">はい</td>
      <td>削除処理が行われる前に実行されます。</td>
    </tr>
  </tbody>
</table>

<p>上記のイベントを使用すると、ビジネスルールをモデルで定義することもできます:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function beforeDelete()
    {
        if ($this-&gt;status === 'A') {
            echo "The robot is active, it can't be deleted";

            return false;
        }

        return true;
    }
}
</code></pre>

<p><a name="hydration-modes"></a></p>

<h2 id="ハイドレーションモード">ハイドレーションモード</h2>

<p>前述のように、結果セットは完全なオブジェクトの集合です。つまり、返される結果はすべて、データベース内の行を表すオブジェクトです。 これらのオブジェクトは変更して、再び永続的に保存することができます:</p>

<pre><code class="language-php">&lt;?php

use Store\Toys\Robots;

$robots = Robots::find();

// 完全なオブジェクトの結果セットを操作する
foreach ($robots as $robot) {
    $robot-&gt;year = 2000;

    $robot-&gt;save();
}
</code></pre>

<p>時として、ユーザーに対して読み取り専用モードでレコードを取得させることがあります。このような場合、レコードの表示方法を変更して処理を簡単にすると便利です。 結果セットとして返されるオブジェクトを指定する方法は、「ハイドレーションモード」と呼ばれます:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model\Resultset;
use Store\Toys\Robots;

$robots = Robots::find();

// すべてのrobotを配列として返す
$robots-&gt;setHydrateMode(
    Resultset::HYDRATE_ARRAYS
);

foreach ($robots as $robot) {
    echo $robot['year'], PHP_EOL;
}

// すべてのrobotを標準クラスとして返す
$robots-&gt;setHydrateMode(
    Resultset::HYDRATE_OBJECTS
);

foreach ($robots as $robot) {
    echo $robot-&gt;year, PHP_EOL;
}

// すべてのrobotをRobotsインスタンスとして返す
$robots-&gt;setHydrateMode(
    Resultset::HYDRATE_RECORDS
);

foreach ($robots as $robot) {
    echo $robot-&gt;year, PHP_EOL;
}
</code></pre>

<p>ハイドレーションモードは、 <code>find</code> のパラメーターとして渡すこともできます:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model\Resultset;
use Store\Toys\Robots;

$robots = Robots::find(
    [
        'hydration' =&gt; Resultset::HYDRATE_ARRAYS,
    ]
);

foreach ($robots as $robot) {
    echo $robot['year'], PHP_EOL;
}
</code></pre>

<p><a name="table-prefixes"></a></p>

<h2 id="テーブル名のプレフィックス">テーブル名のプレフィックス</h2>

<p>すべてのテーブルに特定のプレフィックスがあり、ソースを設定しない場合は、 すべてのモデルに対して <code>Phalcon\Mvc\Model\Manager</code> の <code>setModelPrefix()</code> メソッドが使用できます:</p>

<pre><code class="language-php">&lt;?php

use Phalcon\Mvc\Model\Manager;
use Phalcon\Mvc\Model;

class Robots extends Model
{

}

$manager = new Manager();
$manager-&gt;setModelPrefix('wp_');
$robots = new Robots(null, null, $manager);
echo $robots-&gt;getSource(); // wp_robotsが返される
</code></pre>

<p><a name="identity-columns"></a></p>

<h2 id="自動生成された-id-列">自動生成された id 列</h2>

<p>一部のモデルにはID列があります。 これらの列は通常、マッピングされた表の主キーです。 <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> can recognize the identity column omitting it in the generated SQL <code>INSERT</code>, so the database system can generate an auto-generated value for it. レコードを作成した後は常に、IDフィールドはデータベースシステムで生成された値が設定されます:</p>

<pre><code class="language-php">&lt;?php

$robot-&gt;save();

echo 'The generated id is: ', $robot-&gt;id;
</code></pre>

<p><a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> is able to recognize the identity column. データベースシステムによっては、PostgreSQLのようなシリアルカラムや、MySQLの場合はauto_incrementカラムがあります。</p>

<p>PostgreSQLはシーケンスを使って自動数値を生成しますが、Phalconはシーケンス <code>table_field_seq</code> から生成された値を取得しようとします。例えば: <code>robots_id_seq</code>。そのシーケンスの名前が異なる場合は、 <code>getSequenceName()</code> メソッドを実装する必要があります。</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function getSequenceName()
    {
        return 'robots_sequence_name';
    }
}
</code></pre>

<p><a name="skipping-columns"></a></p>

<h2 id="カラムをスキップ">カラムをスキップ</h2>

<p>To tell <a href="api/Phalcon_Mvc_Model">Phalcon\Mvc\Model</a> that always omits some fields in the creation and/or update of records in order to delegate the database system the assignation of the values by a trigger or a default:</p>

<pre><code class="language-php">&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        // INSERT / UPDATE操作の両方でフィールド/列をスキップします。
        $this-&gt;skipAttributes(
            [
                'year',
                'price',
            ]
        );

        // INSERT時のみスキップする
        $this-&gt;skipAttributesOnCreate(
            [
                'created_at',
            ]
        );

        // UPDATE時のみスキップする
        $this-&gt;skipAttributesOnUpdate(
            [
                'modified_in',
            ]
        );
    }
}
</code></pre>

<p>これにより各 <code>INSERT</code> / <code>UPDATE</code> 操作に対して、アプリケーション全体でこれらのフィールドが無視されます。 <code>INSERT</code> / <code>UPDATE</code> で異なる属性を無視する場合は、置換のために2番目のパラメータ（ブール値） - ` true &lt;/ 0&gt;を指定できます。 デフォルト値を強制するには、次のようにします:&lt;/p&gt;</p>

<pre><code class="php">&lt;?php

use Store\Toys\Robots;

use Phalcon\Db\RawValue;

$robot = new Robots();

$robot-&gt;name       = 'Bender';
$robot-&gt;year       = 1999;
$robot-&gt;created_at = new RawValue('default');

$robot-&gt;create();
`&lt;/pre&gt; 

コールバックを使用して、自動デフォルト値の条件付き割り当てを作成することもできます:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;
use Phalcon\Db\RawValue;

class Robots extends Model
{
    public function beforeCreate()
    {
        if ($this-&gt;price &gt; 10000) {
            $this-&gt;type = new RawValue('default');
        }
    }
}
```

<h5 class="alert alert-warning">Never use a <a href="api/Phalcon_Db_RawValue">Phalcon\Db\RawValue</a> to assign external data (such as user input) or variable data. これらのフィールドの値は、パラメータをクエリにバインドするときは無視されます。 したがって、アプリケーション にSQLインジェクション攻撃できるようになってしまいます。 </h5>

<a name="dynamic-updates"></a>

## ダイナミックアップデート

SQLの `UPDATE` ステートメントはデフォルトで、モデルに定義されたすべての列に対して作成されます（全フィールドの更新SQL）。 特定のモデルを変更して動的に更新を行うことができます。この場合、変更されたフィールドだけが最終的なSQL文の作成に使用されます。

場合によっては、アプリケーションとデータベースサーバー間のトラフィックを減らすことでパフォーマンスを向上させることができます。これは、テーブルにBLOB /テキストフィールドがある場合に特に役立ちます:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this-&gt;useDynamicUpdate(true);
    }
}
```

<a name="column-mapping"></a>

## 独立したカラムマッピング

ORMは、独立したカラムマッピングをサポートしています。これにより開発者は、テーブルのカラム名とは別の名前をモデル内のカラム名として使用することができます。 Phalconは新しいカラム名を認識し、データベースのそれぞれのカラムと一致するように名前を変更します。 これは、コード内のすべてのクエリについて心配することなく、データベース内のフィールドの名前を変更する必要がある場合に便利な機能です。 モデル内のカラムのマッピング変更により、残りの部分が処理されます。 例えば:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public $code;

    public $theName;

    public $theType;

    public $theYear;

    public function columnMap()
    {
        // キーはテーブル内の実際の名前
        // 値はアプリケーション内の名前
        return [
            'id'       =&gt; 'code',
            'the_name' =&gt; 'theName',
            'the_type' =&gt; 'theType',
            'the_year' =&gt; 'theYear',
        ];
    }
}
```

次に、あなたのコードで新しい名前を自然に使うことができます:

```php
&lt;?php

use Store\Toys\Robots;

// 名前でrobotを見つける
$robot = Robots::findFirst(
    "theName = 'Voltron'"
);

echo $robot-&gt;theName, "\n";

// タイプで並び替えてrobotを取得
$robot = Robots::find(
    [
        'order' =&gt; 'theType DESC',
    ]
);

foreach ($robots as $robot) {
    echo 'Code: ', $robot-&gt;code, "\n";
}

// robotを作成
$robot = new Robots();

$robot-&gt;code    = '10101';
$robot-&gt;theName = 'Bender';
$robot-&gt;theType = 'Industrial';
$robot-&gt;theYear = 2999;

$robot-&gt;save();
```

列の名前を変更するときは、次の点を考慮してください:

* リレーションやバリデータの属性への参照は、新しい名前を使用する必要があります
* 実際の列名を参照すると、ORMによる例外が発生します

独立したカラムマッピングは以下を可能にします:

* 独自の規則を使用してアプリケーションを記述する
* コード内のベンダー接頭辞/接尾辞を排除する
* アプリケーションコードを変更せずに列名を変更する

<a name="record-snapshots"></a>

## レコードのスナップショット

特定のモデルはクエリーを実行した際に、レコードのスナップショットを維持するように設定できます。 この機能を使用して、監査を実装したり、永続データの照会時にどのフィールドが変更されるかを知ることができます。

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this-&gt;keepSnapshots(true);
    }
}
```

この機能を有効にすると、アプリケーションは永続データから取得した元の値を追跡するために、少しだけメモリを消費します。 この機能が有効になっているモデルでは、次のように変更されたフィールドを確認できます:

```php
&lt;?php

use Store\Toys\Robots;

// データベースからレコードを取得する
$robot = Robots::findFirst();

// 列を変更する
$robot-&gt;name = 'Other name';

var_dump($robot-&gt;getChangedFields()); // ['name']

var_dump($robot-&gt;hasChanged('name')); // true

var_dump($robot-&gt;hasChanged('type')); // false
```

スナップショットは、モデルの作成/更新時に更新されます。 作成/保存/更新後にフィールドが更新されたかどうかを確認するには、 `hasUpdated()` および `getUpdatedFields()` を使用できます。 しかし `getUpdatedFields()` を `afterUpdate()` 、 `afterSave()` 、 `afterCreate()` の中で実行すると、アプリケーションに問題を引き起こす可能性があります

この機能を無効にするには、次のコマンドを使用します:

```php
Phalcon\Mvc\Model::setup(
    [
        'updateSnapshotOnSave' =&gt; false,
    ]
);
```

または `php.ini` でこれを設定したい場合は、

```ini
phalcon.orm.update_snapshot_on_save = 0
```

この機能を使用すると、次のような効果があります:

```php
&lt;?php

use Phalcon\Mvc\Model;

class User extends Model
{
  public function initialize()
  {
      $this-&gt;keepSnapshots(true);
  }
}

$user       = new User();
$user-&gt;name = 'Test User';
$user-&gt;create();
var_dump($user-&gt;getChangedFields());
$user-&gt;login = 'testuser';
var_dump($user-&gt;getChangedFields());
$user-&gt;update();
var_dump($user-&gt;getChangedFields());
```

On Phalcon 3.4.0 and later it is:

```php
array(0) {
}
array(1) {
[0]=&gt; 
    string(5) "login"
}
array(0) {
}
```

` getUpdatedFields()` は更新されたフィールドを適切に返しますが、上記のように関連するini値を設定することで前の動作に戻ることもできます。

<a name="different-schemas"></a>

## 別のスキーマを指す

モデルが、デフォルトとは異なるスキーマやデータベースのテーブルにマップされている場合。 `setSchema()` メソッドを使用して、以下を定義できます:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this-&gt;setSchema('toys');
    }
}
```

<a name="multiple-databases"></a>

## 複数のデータベースを設定

Phalconでは、すべてのモデルが同じデータベース接続に属しているか、個別のものを持つことができます。 Actually, when [Phalcon\Mvc\Model](api/Phalcon_Mvc_Model) needs to connect to the database it requests the `db` service in the application's services container. このサービス設定は、 `initialize()` メソッドで上書きできます。

```php
&lt;?php

use Phalcon\Db\Adapter\Pdo\Mysql as MysqlPdo;
use Phalcon\Db\Adapter\Pdo\PostgreSQL as PostgreSQLPdo;

// このサービスはMySQLデータベースを返す
$di-&gt;set(
    'dbMysql',
    function () {
        return new MysqlPdo(
            [
                'host'     =&gt; 'localhost',
                'username' =&gt; 'root',
                'password' =&gt; 'secret',
                'dbname'   =&gt; 'invo',
            ]
        );
    }
);

// このサービスはPostgreSQLデータベースを返します
$di-&gt;set(
    'dbPostgres',
    function () {
        return new PostgreSQLPdo(
            [
                'host'     =&gt; 'localhost',
                'username' =&gt; 'postgres',
                'password' =&gt; '',
                'dbname'   =&gt; 'invo',
            ]
        );
    }
);
```

次に、 `initialize()` メソッドで、モデルの接続サービスを定義します:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this-&gt;setConnectionService('dbPostgres');
    }
}
```

しかし、Phalconはあなたにもっと柔軟性を提供します。あなたは `read` と `write` に使わなければならない接続を定義できます。 これは、マスタとスレーブのアーキテクチャを実装するデータベースと負荷のバランスをとるのに特に役立ちます:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function initialize()
    {
        $this-&gt;setReadConnectionService('dbSlave');

        $this-&gt;setWriteConnectionService('dbMaster');
    }
}
```

ORMは、現在のクエリ条件に従って「シャード」選択を実装できるようにすることで、Horizontal Sharding機能も提供します。

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    /**
     * シャードを動的に選択
     *
     * @param array $intermediate
     * @param array $bindParams
     * @param array $bindTypes
     */
    public function selectReadConnection($intermediate, $bindParams, $bindTypes)
    {
        // select文に 'where' 句があるかどうかを確認する
        if (isset($intermediate['where'])) {
            $conditions = $intermediate['where'];

            // 条件に応じて可能なシャードを選択する
            if ($conditions['left']['name'] === 'id') {
                $id = $conditions['right']['value'];

                if ($id &gt; 0 &amp;&amp; $id &lt; 10000) {
                    return $this-&gt;getDI()-&gt;get('dbShard1');
                }

                if ($id &gt; 10000) {
                    return $this-&gt;getDI()-&gt;get('dbShard2');
                }
            }
        }

        // デフォルトのシャードを使用する
        return $this-&gt;getDI()-&gt;get('dbShard0');
    }
}
```

`selectReadConnection()` メソッドは、正しい接続を選択するために呼び出されます。このメソッドは、実行された新しいクエリをインターセプトします:

```php
&lt;?php

use Store\Toys\Robots;

$robot = Robots::findFirst('id = 101');
```

<a name="injecting-services-into-models"></a>

## モデルへのサービスインジェクション

モデル内でアプリケーションサービスにアクセスする必要がある場合があります。次の例は、その方法を説明しています:

```php
&lt;?php

namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function notSaved()
    {
        // DIコンテナからflashサービスを取得する
        $flash = $this-&gt;getDI()-&gt;getFlash();

        $messages = $this-&gt;getMessages();

        // バリデーションメッセージを表示
        foreach ($messages as $message) {
            $flash-&gt;error($message);
        }
    }
}
```

`notSaved` イベントは、`create` または `update` アクションが失敗するたびにトリガーされます。 そしてDIコンテナから `flash` サービスを取得して、バリデーションメッセージをフラッシュさせます。 これにより、保存後に毎回メッセージを出力する必要が無くなります。

<a name="disabling-enabling-features"></a>

## 機能の有効/無効

ORMでは、特定の機能やオプションをオンザフライでグローバルに有効/無効にする仕組みを実装しました。 ORMの使い方に応じて、使用していないものを無効にすることができます。 これらのオプションは、必要に応じて一時的に無効にすることもできます。

```php
&lt;?php

use Phalcon\Mvc\Model;

Model::setup(
    [
        'events'         =&gt; false,
        'columnRenaming' =&gt; false,
    ]
);
```

使用可能なオプションは次のとおりです:

| オプション                 | 説明                                                                 |  デフォルト  |
| --------------------- | ------------------------------------------------------------------ |:-------:|
| astCache              | すべてのモデルのコールバック、フック、イベント通知を有効/無効にする                                 | `null`  |
| cacheLevel            | ORMのキャッシュレベルを設定します。                                                |   `3`   |
| castOnHydrate         |                                                                    | `false` |
| columnRenaming        | 列名の変更を有効または無効にします。                                                 | `true`  |
| disableAssignSetters  | モデル内のセッターを無効にすることを許可する                                             | `false` |
| enableImplicitJoins   |                                                                    | `true`  |
| enableLiterals        |                                                                    | `true`  |
| escapeIdentifiers     |                                                                    | `true`  |
| events                | すべてのモデルのコールバック、フック、イベント通知を有効/無効にする                                 | `true`  |
| exceptionOnFailedSave | 失敗した `save()` が存在する場合に例外をスローするかどうかを設定します。                          | `false` |
| forceCasting          |                                                                    | `false` |
| ignoreUnknownColumns  | モデル上の未知の列の無視を有効または無効にする                                            | `false` |
| lateStateBinding      | `Phalcon\Mvc\Model::cloneResultMap()` メソッドの遅延バインディングを有効または無効にします | `false` |
| notNullValidations    | ORMは、マップされた表に存在するNOT NULL列を自動的に検証します                               | `true`  |
| parserCache           |                                                                    | `null`  |
| phqlLiterals          | PHQLパーサのリテラルを有効/無効にする                                              | `true`  |
| uniqueCacheId         |                                                                    |   `3`   |
| updateSnapshotOnSave  | `save()` でスナップショットの更新を有効または無効にします。                                 | `true`  |
| virtualForeignKeys    | 仮想外部キーを有効/無効にします。                                                  | `true`  |

<div class="alert alert-warning">
    <p>
        <strong>備考</strong> <code>Phalcon\Mvc\Model::assign()</code> （モデルの作成/更新/保存時にも使用されます）は、データ引数が渡されたときには常にセッターが使われます。 これにより、アプリケーションにオーバーヘッドが追加されます。 この動作を変更するには、 <code>phalcon.orm.disable_assign_setters = 1</code> をiniファイルに追加します。これは単に <code>$this-&gt;property = value</code> を使用するだけです。
    </p>
</div>

<a name="stand-alone-component"></a>

## 独立コンポーネント

Using [Phalcon\Mvc\Model](api/Phalcon_Mvc_Model) in a stand-alone mode can be demonstrated below:

```php
&lt;?php

use Phalcon\Di;
use Phalcon\Mvc\Model;
use Phalcon\Mvc\Model\Manager as ModelsManager;
use Phalcon\Db\Adapter\Pdo\Sqlite as Connection;
use Phalcon\Mvc\Model\Metadata\Memory as MetaData;

$di = new Di();

// コネクションの初期化
$di-&gt;set(
    'db',
    new Connection(
        [
            'dbname' =&gt; 'sample.db',
        ]
    )
);

// モデルマネージャを設定する
$di-&gt;set(
    'modelsManager',
    new ModelsManager()
);

// メタデータ記憶アダプターなどを使用する
$di-&gt;set(
    'modelsMetadata',
    new MetaData()
);

// モデルを作成する
class Robots extends Model
{

}

// モデルを使用する
echo Robots::count();
```
</code></pre>

                    </div>
                </div>
            </div>
        </div>
    </div>

<footer>
    <div class="container">
        <div class="footer-wrapper clearfix">

            <div class="footer-link-container">
                <a class="footer-link" href="/">
                    <img class="footer-logo-img" src="/assets/images/footer_logo.svg" alt="logo">
                </a>
                <a class="footer-link" href="https://phalcon.link/about" target="_blank">
                    About
                </a>
                <a class="footer-link" href="https://phalcon.link/sponsors" target="_blank">
                    Sponsors
                </a>
                <a class="footer-link" href="https://phalcon.link/fund" target="_blank">
                    Support Us
                </a>
                <a class="footer-link" href="https://phalcon.link/download" target="_blank">
                    Download
                </a>
                <a class="footer-link" href="https://license.phalconphp.com/" target="_blank">
                    License New BSD
                </a>
            </div>

            <div class="footer-copyright">
                <a href="https://odva.pro/" target="_blank" class="o2-link">
                    <span>Development by</span> <img src="/assets/images/logo-o2.svg" alt="logo o2">
                </a>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript" src="/assets/js/main.min.js?v1547319779866581049"></script>
<script type="text/javascript" src="/assets/js/highlight/highlight.pack.js?v1547319779866581049"></script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
<script type="application/javascript">hljs.initHighlightingOnLoad();</script>
</body>
</html>
